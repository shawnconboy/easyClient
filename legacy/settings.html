<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Settings â€“ Easy Client</title>
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <div class="container">
        <aside class="sidebar">
            <h2>Easy Client</h2>
            <nav>
                <a href="index.html">Dashboard</a>
                <a href="companies.html">Companies</a>
                <a href="users.html">Users</a>
                <a href="settings.html" class="active">Settings</a>
                <a href="landing.html">Landing Page</a>
            </nav>
        </aside>
        <main class="main">
            <header class="topbar">
                <h1>Settings</h1>
                <div class="user-box" id="user-box"
                    style="margin-left:auto; display:flex; align-items:center; gap:1em;">
                    <button id="auth-btn" title="Sign in">
                        Sign In
                    </button>
                </div>
                <!-- User modal -->
                <div id="user-modal" class="user-modal">
                    <div class="user-modal-inner">
                        <div id="user-modal-email" class="user-modal-email"></div>
                        <button id="logout-btn" class="logout-btn">Log Out</button>
                    </div>
                </div>
            </header>
            <section class="content">
                <!-- User Info Section -->
                <div id="user-info-section" class="card section-space"
                    style="display:none; max-width:400px; margin-bottom:2em;">
                    <h3 style="margin-top:0; color:#1976d2;">Your Account</h3>
                    <div class="form-row" style="margin-bottom:1em;">
                        <label style="font-weight:600; color:#555;">Name:</label>
                        <span id="user-info-name" style="margin-left:0.5em; color:#222;"></span>
                    </div>
                    <div class="form-row" style="margin-bottom:1em;">
                        <label style="font-weight:600; color:#555;">Email:</label>
                        <span id="user-info-email" style="margin-left:0.5em; color:#222;"></span>
                    </div>
                    <button id="reset-password-btn" class="btn"
                        style="margin-top:0.5em; background:#1976d2; color:#fff; border:none; padding:0.5em 1.2em; border-radius:4px; cursor:pointer;">
                        Reset Password
                    </button>
                    <div id="reset-password-msg" style="margin-top:0.75em; font-size:0.95em; display:none;">
                    </div>
                </div>
            </section>
        </main>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA9iKdL-7YCBWrqbBmLFkw--pS0kET7qZc",
            authDomain: "easyclient-ac627.firebaseapp.com",
            projectId: "easyclient-ac627",
            storageBucket: "easyclient-ac627.firebasestorage.app",
            messagingSenderId: "247790149498",
            appId: "1:247790149498:web:6d03859eaa5394f17fc0c3",
            measurementId: "G-SF966FYKGB"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const authBtn = document.getElementById('auth-btn');
        const userModal = document.getElementById('user-modal');
        const userModalEmail = document.getElementById('user-modal-email');
        const logoutBtn = document.getElementById('logout-btn');

        // User info section elements
        const userInfoSection = document.getElementById('user-info-section');
        const userInfoName = document.getElementById('user-info-name');
        const userInfoEmail = document.getElementById('user-info-email');
        const resetPasswordBtn = document.getElementById('reset-password-btn');
        const resetPasswordMsg = document.getElementById('reset-password-msg');

        let userEmail = "";

        function showUserModal() {
            userModal.style.display = 'block';
            userModalEmail.textContent = userEmail;
            setTimeout(() => {
                document.addEventListener('mousedown', handleOutsideClick);
            }, 0);
        }
        function hideUserModal() {
            userModal.style.display = 'none';
            document.removeEventListener('mousedown', handleOutsideClick);
        }
        function handleOutsideClick(e) {
            if (!userModal.contains(e.target) && e.target !== authBtn) {
                hideUserModal();
            }
        }

        onAuthStateChanged(auth, async user => {
            if (user) {
                let displayName = user.displayName;
                let role = null;
                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists()) {
                        const data = userDoc.data();
                        if (data.name) displayName = data.name;
                        role = data.role;
                    }
                } catch { }
                // Only allow admin or owner
                if (role !== "admin" && role !== "owner") {
                    window.location.href = "landing.html";
                    return;
                }
                // Unified sidebar for owner role
                if (role === "owner") {
                    const nav = document.querySelector('.sidebar nav');
                    nav.innerHTML = `
                <a href="index.html">Dashboard</a>
                <a href="clients.html">Clients</a>
                <a href="settings.html" class="active">Settings</a>
            `;
                }
                userEmail = user.email;
                authBtn.textContent = displayName || user.email;
                authBtn.title = "Account";
                authBtn.style.background = "#1976d2";
                authBtn.style.color = "#fff";
                authBtn.onclick = (e) => {
                    e.stopPropagation();
                    if (userModal.style.display === 'block') {
                        hideUserModal();
                    } else {
                        showUserModal();
                    }
                };
                logoutBtn.onclick = async () => {
                    await signOut(auth);
                    hideUserModal();
                };

                // Show user info section
                userInfoSection.style.display = "block";
                userInfoName.textContent = displayName || "(not set)";
                userInfoEmail.textContent = user.email;

                resetPasswordBtn.onclick = async () => {
                    resetPasswordMsg.style.display = "none";
                    resetPasswordMsg.style.color = "#1976d2";
                    try {
                        await sendPasswordResetEmail(auth, user.email);
                        resetPasswordMsg.textContent = "Password reset email sent! Please check your inbox and spam/junk folder.";
                        resetPasswordMsg.style.display = "block";
                    } catch (err) {
                        resetPasswordMsg.textContent = `Error: ${err.code || ''} ${err.message || ''}`;
                        resetPasswordMsg.style.display = "block";
                        resetPasswordMsg.style.color = "red";
                    }
                };
            } else {
                window.location.href = "landing.html";
                userInfoSection.style.display = "none";
            }
        });
    </script>
</body>

</html>