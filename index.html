<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Easy Client</title>
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <div class="container">
        <aside class="sidebar">
            <h2>Easy Client</h2>
            <nav>
                <a href="index.html" class="active">Dashboard</a>
                <a href="companies.html">Companies</a>
                <a href="#">Users</a>
                <a href="settings.html">Settings</a>
                <a href="landing.html">Landing Page</a>
            </nav>
        </aside>
        <main class="main">
            <header class="topbar">
                <h1>Admin Dashboard</h1>
                <div class="user-box" id="user-box"
                    style="margin-left:auto; display:flex; align-items:center; gap:1em;">
                    <button id="auth-btn" title="Sign in">
                        Sign In
                    </button>
                </div>
                <!-- User modal -->
                <div id="user-modal" class="user-modal">
                    <div class="user-modal-inner">
                        <div id="user-modal-email" class="user-modal-email"></div>
                        <button id="logout-btn" class="logout-btn">Log Out</button>
                    </div>
                </div>
            </header>
            <section class="content">
                <h2>All Companies</h2>
                <div class="cards" id="dashboard-companies-cards">
                    <!-- Company cards will be injected here -->
                </div>
                <button id="see-all-companies-btn" class="logout-btn"
                    style="margin-top:1em; background:#1976d2; color:#fff;">See All</button>
            </section>
        </main>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, getDocs, query, limit } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // Unified Firebase config (replace with your actual config if needed)
        const firebaseConfig = {
            apiKey: "AIzaSyA9iKdL-7YCBWrqbBmLFkw--pS0kET7qZc",
            authDomain: "easyclient-ac627.firebaseapp.com",
            projectId: "easyclient-ac627",
            storageBucket: "easyclient-ac627.firebasestorage.app",
            messagingSenderId: "247790149498",
            appId: "1:247790149498:web:6d03859eaa5394f17fc0c3",
            measurementId: "G-SF966FYKGB"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const authBtn = document.getElementById('auth-btn');
        const userModal = document.getElementById('user-modal');
        const userModalEmail = document.getElementById('user-modal-email');
        const logoutBtn = document.getElementById('logout-btn');
        let userEmail = "";

        function showUserModal() {
            userModal.style.display = 'block';
            userModalEmail.textContent = userEmail;
            setTimeout(() => {
                document.addEventListener('mousedown', handleOutsideClick);
            }, 0);
        }
        function hideUserModal() {
            userModal.style.display = 'none';
            document.removeEventListener('mousedown', handleOutsideClick);
        }
        function handleOutsideClick(e) {
            if (!userModal.contains(e.target) && e.target !== authBtn) {
                hideUserModal();
            }
        }

        onAuthStateChanged(auth, async user => {
            if (user) {
                let displayName = user.displayName;
                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists() && userDoc.data().name) {
                        displayName = userDoc.data().name;
                    }
                } catch { }
                userEmail = user.email;
                authBtn.textContent = displayName || user.email;
                authBtn.title = "Account";
                authBtn.style.background = "#1976d2";
                authBtn.style.color = "#fff";
                authBtn.onclick = (e) => {
                    e.stopPropagation();
                    if (userModal.style.display === 'block') {
                        hideUserModal();
                    } else {
                        showUserModal();
                    }
                };
                logoutBtn.onclick = async () => {
                    await signOut(auth);
                    hideUserModal();
                };
            } else {
                userEmail = "";
                authBtn.textContent = "Sign In";
                authBtn.title = "Sign in";
                authBtn.onclick = () => {
                    window.location.href = `login.html?redirect=${encodeURIComponent(window.location.pathname + window.location.search)}`;
                };
                authBtn.style.background = "#1976d2";
                authBtn.style.color = "#fff";
                hideUserModal();
            }
        });

        // Fetch and display a few companies on the dashboard
        async function loadDashboardCompanies() {
            const cardsContainer = document.getElementById('dashboard-companies-cards');
            cardsContainer.innerHTML = '<p>Loading...</p>';
            try {
                const companiesQuery = query(collection(db, "companies"), limit(3));
                const querySnapshot = await getDocs(companiesQuery);
                let html = '';
                querySnapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    html += `
                        <div class="card">
                            <h3>${data.name || 'Unnamed Company'}</h3>
                            <div class="cardOwner">
                                <p>Owner</p>
                                <p>${data.ownerName || 'Unknown'}</p>
                            </div>
                            <button onclick="window.location.href='companies.html?id=${docSnap.id}'">View</button>
                        </div>
                    `;
                });
                cardsContainer.innerHTML = html || '<p>No companies found.</p>';
            } catch (e) {
                cardsContainer.innerHTML = '<p>Error loading companies.</p>';
            }
        }

        loadDashboardCompanies();

        // See All button
        document.getElementById('see-all-companies-btn').onclick = () => {
            window.location.href = 'companies.html';
        };
    </script>
</body>

</html>