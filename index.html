<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Easy Client</title>
    <link rel="stylesheet" href="style.css" />
</head>


<body>
    <div id="spa-root"></div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, sendPasswordResetEmail, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, getDocs, query, where, addDoc, updateDoc, setDoc, deleteDoc, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyA9iKdL-7YCBWrqbBmLFkw--pS0kET7qZc",
            authDomain: "easyclient-ac627.firebaseapp.com",
            projectId: "easyclient-ac627",
            storageBucket: "easyclient-ac627.firebasestorage.app",
            messagingSenderId: "247790149498",
            appId: "1:247790149498:web:6d03859eaa5394f17fc0c3",
            measurementId: "G-SF966FYKGB"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Utility functions
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString();
        }

        function formatTime(timeStr) {
            return timeStr;
        }

        // Convert 24-hour time to 12-hour AM/PM format
        function formatTime12Hour(hour) {
            if (hour === 0) return '12:00 AM';
            if (hour < 12) return `${hour}:00 AM`;
            if (hour === 12) return '12:00 PM';
            return `${hour - 12}:00 PM`;
        }

        // Convert time string (like "14:30") to 12-hour format
        function formatTimeString12Hour(timeStr) {
            if (!timeStr) return '';
            const [hours, minutes] = timeStr.split(':');
            const hour = parseInt(hours);
            const min = minutes || '00';

            if (hour === 0) return `12:${min} AM`;
            if (hour < 12) return `${hour}:${min} AM`;
            if (hour === 12) return `12:${min} PM`;
            return `${hour - 12}:${min} PM`;
        }

        // Authorization helper
        function hasPermission(action, companyId = null) {
            if (!currentUser || !currentRole) return false;

            switch (action) {
                case 'view_all_companies':
                case 'create_company':
                case 'view_all_users':
                    return currentRole === 'admin';

                case 'manage_company':
                case 'view_company_data':
                case 'manage_bookings':
                case 'manage_clients':
                    if (currentRole === 'admin') return true;
                    if (currentRole === 'owner' && companyId === currentUser.uid) return true;
                    return false;

                case 'view_own_bookings':
                    return currentRole === 'client' || currentRole === 'owner' || currentRole === 'admin';

                default:
                    return false;
            }
        }
        const auth = getAuth(app);

        // SPA root
        const root = document.getElementById('spa-root');

        // Simple router
        function route(path) {
            // Only update history if the path is different
            if (window.location.pathname !== path) {
                window.history.pushState({}, '', path);
            }
            renderView(path);
        }
        window.addEventListener('popstate', () => renderView(window.location.pathname));

        // Auth state and role
        let currentUser = null;
        let currentRole = null;
        let currentWeekOffset = 0; // 0 = current week, -1 = previous week, 1 = next week

        // Sidebar rendering
        function renderSidebar() {
            let links = [];
            if (currentRole === 'owner') {
                links = [
                    { href: '/dashboard', label: 'Dashboard' },
                    { href: '/clients', label: 'Clients' },
                    { href: '/settings', label: 'Settings' }
                ];
            } else if (currentRole === 'admin') {
                links = [
                    { href: '/dashboard', label: 'Dashboard' },
                    { href: '/companies', label: 'Companies' },
                    { href: '/users', label: 'Users' },
                    { href: '/settings', label: 'Settings' },
                    { href: '/landing', label: 'Landing Page' }
                ];
            }
            return `
                <aside class="sidebar">
                    <h2>Easy Client</h2>
                    <nav>
                        ${links.map(link => `<a href="${link.href}" class="spa-link">${link.label}</a>`).join('')}
                    </nav>
                </aside>
            `;
        }

        // Helper to format phone numbers for display
        function formatPhone(phone) {
            // Remove all non-digit characters
            const digits = (phone || '').replace(/\D/g, '');
            if (digits.length === 10) {
                return `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6, 10)}`;
            }
            return phone || '';
        }

        // Views
        async function renderLanding() {
            root.innerHTML = `
        <section class="hero" style="padding:64px 0 48px 0;background:linear-gradient(90deg,#4f46e5 0%,#6366f1 100%);color:#fff;text-align:center;">
            <h1 style="font-size:2.8em;font-weight:800;line-height:1.1;margin-bottom:22px;">
                Grow Your Service Business Effortlessly
            </h1>
            <p style="font-size:1.25em;max-width:540px;margin:0 auto 28px auto;">
                Easy Client is the modern, all-in-one booking and business management platform built for service business owners. Get more clients, save time, and scale your business with powerful tools designed for you.
            </p>
            <button class="cta-btn" id="get-started-btn" style="padding:16px 38px;font-size:1.18em;font-weight:700;border-radius:9px;background:#fff;color:#4f46e5;box-shadow:0 2px 12px rgba(79,70,229,0.12);border:none;cursor:pointer;transition:background 0.2s;">Get Started Free</button>
            <div style="margin-top:18px;font-size:1.05em;color:#e0e7ff;">No credit card required. Start in minutes.</div>
        </section>
        <section class="features" style="padding:56px 0 48px 0;background:#f8fafc;">
            <div style="max-width:1100px;margin:0 auto;">
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:32px;">
                    <div style="background:#fff;padding:28px 22px;border-radius:14px;box-shadow:0 4px 24px rgba(0,0,0,0.07);">
                        <h3 style="color:#4f46e5;font-size:1.25em;font-weight:700;margin-bottom:12px;">Online Booking</h3>
                        <p style="color:#222;">Let clients book appointments 24/7. Automated reminders reduce no-shows and keep your calendar full.</p>
                    </div>
                    <div style="background:#fff;padding:28px 22px;border-radius:14px;box-shadow:0 4px 24px rgba(0,0,0,0.07);">
                        <h3 style="color:#4f46e5;font-size:1.25em;font-weight:700;margin-bottom:12px;">Client Management</h3>
                        <p style="color:#222;">Keep all your client info organized and accessible. Track history, notes, and communication in one place.</p>
                    </div>
                    <div style="background:#fff;padding:28px 22px;border-radius:14px;box-shadow:0 4px 24px rgba(0,0,0,0.07);">
                        <h3 style="color:#4f46e5;font-size:1.25em;font-weight:700;margin-bottom:12px;">Automated Invoicing</h3>
                        <p style="color:#222;">Send professional invoices and get paid faster. Accept payments online with ease.</p>
                    </div>
                    <div style="background:#fff;padding:28px 22px;border-radius:14px;box-shadow:0 4px 24px rgba(0,0,0,0.07);">
                        <h3 style="color:#4f46e5;font-size:1.25em;font-weight:700;margin-bottom:12px;">Business Insights</h3>
                        <p style="color:#222;">See your earnings, top clients, and growth trends at a glance. Make smarter decisions with real data.</p>
                    </div>
                    <div style="background:#fff;padding:28px 22px;border-radius:14px;box-shadow:0 4px 24px rgba(0,0,0,0.07);">
                        <h3 style="color:#4f46e5;font-size:1.25em;font-weight:700;margin-bottom:12px;">Team Scheduling</h3>
                        <p style="color:#222;">Manage your staff and their calendars. Assign jobs, track hours, and avoid double-booking.</p>
                    </div>
                    <div style="background:#fff;padding:28px 22px;border-radius:14px;box-shadow:0 4px 24px rgba(0,0,0,0.07);">
                        <h3 style="color:#4f46e5;font-size:1.25em;font-weight:700;margin-bottom:12px;">Marketing Tools</h3>
                        <p style="color:#222;">Send promotions, automate follow-ups, and grow your client base with built-in marketing features.</p>
                    </div>
                </div>
                <div style="text-align:center;margin-top:48px;">
                    <span style="font-size:1.1em;color:#4f46e5;font-weight:600;">Join hundreds of business owners who trust Easy Client to grow their business.</span>
                </div>
            </div>
        </section>
        <div class="footer" style="padding:24px 0;text-align:center;color:#888;background:#fff;">&copy; 2025 Easy Client. All rights reserved.</div>
    `;
            document.getElementById('get-started-btn').onclick = () => route('/login');
        }

        async function renderLogin() {
            root.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:center;min-height:100vh;">
        <div class="login-container" style="min-width:420px;max-width:520px;margin:0 auto;padding:32px 28px;background:#fff;border-radius:14px;box-shadow:0 4px 24px rgba(0,0,0,0.07);display:flex;flex-direction:column;align-items:center;">
            <h1 style="margin-bottom:28px;font-size:2em;font-weight:700;color:#222;">Sign In</h1>
            <form id="login-form" style="width:100%;display:flex;flex-direction:column;gap:18px;">
                <input type="email" id="login-email" placeholder="Email" required style="padding:12px 14px;border-radius:7px;border:1px solid #e5e7eb;font-size:1em;">
                <input type="password" id="login-password" placeholder="Password" required style="padding:12px 14px;border-radius:7px;border:1px solid #e5e7eb;font-size:1em;">
                <button type="submit" id="login-btn" style="padding:12px 0;border-radius:7px;background:#4f46e5;color:#fff;font-size:1.08em;font-weight:600;border:none;cursor:pointer;margin-top:8px;">Sign In</button>
                <div id="login-error" style="color:#c62828;display:none;font-size:0.98em;margin-top:-10px;"></div>
            </form>
            <hr style="width:100%;margin:28px 0 18px 0;border:none;border-top:1px solid #e5e7eb;">
            <div style="display:flex;justify-content:space-between;width:100%;gap:12px;">
                <button type="button" id="signup-btn" style="flex:1;padding:10px 0;border-radius:7px;background:#f8fafc;color:#222;font-weight:600;border:1px solid #e5e7eb;cursor:pointer;">Sign Up</button>
                <button type="button" id="reset-btn" style="flex:1;padding:10px 0;border-radius:7px;background:#f8fafc;color:#222;font-weight:600;border:1px solid #e5e7eb;cursor:pointer;">Forgot Password</button>
            </div>
        </div>
    </div>
        <div id="signup-role-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:1000;align-items:center;justify-content:center;">
            <div style="background:#fff;padding:32px 28px;border-radius:14px;box-shadow:0 4px 24px rgba(0,0,0,0.09);max-width:370px;width:100%;margin:auto;">
                <h2 style="margin-bottom:22px;font-size:1.4em;font-weight:700;text-align:center;">Sign Up As...</h2>
                <div style="display:flex;gap:18px;justify-content:center;margin-bottom:18px;">
                    <button id="signup-owner-btn" style="padding:12px 24px;border-radius:8px;background:#fff;color:#222;font-weight:600;border:2px solid #e5e7eb;cursor:pointer;">Business Owner</button>
                    <button id="signup-client-btn" style="padding:12px 24px;border-radius:8px;background:#fff;color:#222;font-weight:600;border:2px solid #e5e7eb;cursor:pointer;">Client</button>
                </div>
                <button id="signup-role-modal-close" style="display:block;margin:0 auto;margin-top:10px;background:none;border:none;color:#888;font-size:1.1em;cursor:pointer;">Cancel</button>
            </div>
        </div>
        <div id="signup-form-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:1001;align-items:center;justify-content:center;">
            <div id="signup-form-modal-content" style="background:#fff;padding:32px 28px;border-radius:14px;box-shadow:0 4px 24px rgba(0,0,0,0.09);max-width:370px;width:100%;margin:auto;">
                <!-- Form will be injected here -->
            </div>
        </div>
        <div id="reset-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:1000;align-items:center;justify-content:center;">
            <div style="background:#fff;padding:32px 28px;border-radius:14px;box-shadow:0 4px 24px rgba(0,0,0,0.09);max-width:370px;width:100%;margin:auto;">
                <h2 style="margin-bottom:22px;font-size:1.4em;font-weight:700;text-align:center;">Reset Password</h2>
                <form id="reset-modal-form" style="display:flex;flex-direction:column;gap:14px;">
                    <input type="email" id="reset-modal-email" placeholder="Enter your email" required style="padding:11px 13px;border-radius:7px;border:1px solid #e5e7eb;">
                    <div id="reset-modal-error" style="color:#c62828;display:none;font-size:0.98em;"></div>
                    <button type="submit" style="padding:12px 0;border-radius:7px;background:#4f46e5;color:#fff;font-size:1.08em;font-weight:600;border:none;cursor:pointer;">Send Reset Email</button>
                </form>
                <button id="reset-modal-close" style="display:block;margin:0 auto;margin-top:10px;background:none;border:none;color:#888;font-size:1.1em;cursor:pointer;">Cancel</button>
            </div>
        </div>
    `;
            // Login logic
            const form = document.getElementById('login-form');
            form.onsubmit = async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                const errorBox = document.getElementById('login-error');
                errorBox.style.display = 'none';
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (err) {
                    errorBox.textContent = "Invalid email or password.";
                    errorBox.style.display = 'block';
                }
            };
            document.getElementById('signup-btn').onclick = () => {
                document.getElementById('signup-role-modal').style.display = 'flex';
            };
            document.getElementById('reset-btn').onclick = () => {
                document.getElementById('reset-modal').style.display = 'flex';
            };
            document.getElementById('signup-role-modal-close').onclick = () => {
                document.getElementById('signup-role-modal').style.display = 'none';
                document.getElementById('signup-owner-btn').style.borderColor = "#e5e7eb";
                document.getElementById('signup-client-btn').style.borderColor = "#e5e7eb";
            };
            document.getElementById('reset-modal-close').onclick = () => {
                document.getElementById('reset-modal').style.display = 'none';
                document.getElementById('reset-modal-error').textContent = '';
                document.getElementById('reset-modal-error').style.display = 'none';
            };

            // Modal logic - two stage
            document.getElementById('signup-owner-btn').onclick = () => {
                document.getElementById('signup-owner-btn').style.borderColor = "#4f46e5";
                document.getElementById('signup-client-btn').style.borderColor = "#e5e7eb";
                document.getElementById('signup-role-modal').style.display = 'none';
                document.getElementById('signup-form-modal').style.display = 'flex';
                document.getElementById('signup-form-modal-content').innerHTML = `
            <h2 style="margin-bottom:18px;font-size:1.2em;font-weight:700;text-align:center;">Business Owner Sign Up</h2>
            <form id="signup-owner-form" style="display:flex;flex-direction:column;gap:14px;">
                <input type="text" id="signup-business" placeholder="Business Name" required style="padding:11px 13px;border-radius:7px;border:1px solid #e5e7eb;">
                <input type="text" id="signup-name" placeholder="Your Name" required style="padding:11px 13px;border-radius:7px;border:1px solid #e5e7eb;">
                <input type="email" id="signup-email" placeholder="Email" required style="padding:11px 13px;border-radius:7px;border:1px solid #e5e7eb;">
                <input type="password" id="signup-password" placeholder="Password" required style="padding:11px 13px;border-radius:7px;border:1px solid #e5e7eb;">
                <input type="password" id="signup-confirm" placeholder="Confirm Password" required style="padding:11px 13px;border-radius:7px;border:1px solid #e5e7eb;">
                <input type="tel" id="signup-phone" placeholder="Phone Number" required style="padding:11px 13px;border-radius:7px;border:1px solid #e5e7eb;">
                <div id="signup-error" style="color:#c62828;display:none;font-size:0.98em;"></div>
                <button type="submit" style="padding:12px 0;border-radius:7px;background:#4f46e5;color:#fff;font-size:1.08em;font-weight:600;border:none;cursor:pointer;">Create Account</button>
            </form>
            <button id="signup-form-modal-close" style="display:block;margin:0 auto;margin-top:10px;background:none;border:none;color:#888;font-size:1.1em;cursor:pointer;">Cancel</button>
        `;
                document.getElementById('signup-form-modal-close').onclick = () => {
                    document.getElementById('signup-form-modal').style.display = 'none';
                    document.getElementById('signup-owner-btn').style.borderColor = "#e5e7eb";
                };
                const ownerForm = document.getElementById('signup-owner-form');
                ownerForm.onsubmit = async (e) => {
                    e.preventDefault();
                    const business = document.getElementById('signup-business').value.trim();
                    const name = document.getElementById('signup-name').value.trim();
                    const email = document.getElementById('signup-email').value.trim();
                    const password = document.getElementById('signup-password').value;
                    const confirm = document.getElementById('signup-confirm').value;
                    const phoneRaw = document.getElementById('signup-phone').value.trim();
                    const phone = phoneRaw.replace(/\s+/g, ''); // strip whitespace
                    const errorBox = document.getElementById('signup-error');
                    errorBox.style.display = 'none';
                    if (password !== confirm) {
                        errorBox.textContent = "Passwords do not match.";
                        errorBox.style.display = 'block';
                        return;
                    }
                    try {
                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        const user = userCredential.user;
                        const userData = {
                            name,
                            email,
                            phone,
                            role: 'owner',
                            business,
                            companyId: user.uid,
                            status: 'active',
                            createdAt: new Date().toISOString()
                        };
                        await setDoc(doc(db, 'users', user.uid), userData);
                        await setDoc(doc(db, 'companies', user.uid), {
                            name: business,
                            ownerUid: user.uid,
                            ownerEmail: email,
                            ownerName: name,
                            ownerPhone: phone,
                            services: [],
                            settings: {
                                timezone: 'America/New_York',
                                bookingWindow: 30,
                                cancellationPolicy: '24 hours notice required',
                                notifications: {
                                    emailEnabled: true,
                                    smsEnabled: false
                                }
                            },
                            totalRevenue: 0,
                            createdAt: new Date().toISOString()
                        });
                        document.getElementById('signup-form-modal').style.display = 'none';
                        route('/dashboard');
                    } catch (err) {
                        errorBox.textContent = err.message.replace('Firebase: ', '');
                        errorBox.style.display = 'block';
                    }
                };
            };

            document.getElementById('signup-client-btn').onclick = () => {
                document.getElementById('signup-client-btn').style.borderColor = "#4f46e5";
                document.getElementById('signup-owner-btn').style.borderColor = "#e5e7eb";
                document.getElementById('signup-role-modal').style.display = 'none';
                document.getElementById('signup-form-modal').style.display = 'flex';
                document.getElementById('signup-form-modal-content').innerHTML = `
            <h2 style="margin-bottom:18px;font-size:1.2em;font-weight:700;text-align:center;color:#4f46e5;">Client Access</h2>
            <div style="text-align:center;padding:20px;background:#f8fafc;border-radius:8px;margin-bottom:20px;">
                <p style="margin-bottom:16px;color:#374151;line-height:1.5;">
                    Clients don't need to sign up directly. Your business owner will add you to their client list, 
                    and you'll receive booking links and communication through their system.
                </p>
                <p style="color:#6b7280;font-size:0.9em;">
                    If you're a business owner, please select "Business Owner" instead.
                </p>
            </div>
            <button id="signup-form-modal-close" style="display:block;margin:0 auto;padding:10px 24px;background:#4f46e5;color:#fff;border:none;border-radius:7px;font-weight:600;cursor:pointer;">Got it</button>
        `;
                document.getElementById('signup-form-modal-close').onclick = () => {
                    document.getElementById('signup-form-modal').style.display = 'none';
                    document.getElementById('signup-client-btn').style.borderColor = "#e5e7eb";
                };
            };

            // Forgot password modal logic
            document.getElementById('reset-modal-form').onsubmit = async (e) => {
                e.preventDefault();
                const email = document.getElementById('reset-modal-email').value.trim();
                const errorBox = document.getElementById('reset-modal-error');
                errorBox.style.display = 'none';
                try {
                    await sendPasswordResetEmail(auth, email);
                    errorBox.textContent = "Password reset email sent.";
                    errorBox.style.color = '#1976d2';
                    errorBox.style.display = 'block';
                } catch (err) {
                    errorBox.textContent = err.message.replace('Firebase: ', '');
                    errorBox.style.color = '#c62828';
                    errorBox.style.display = 'block';
                }
            };
        }

        async function renderSignup() {
            root.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:center;min-height:100vh;">
            <div class="login-container" style="min-width:300px;max-width:420px;margin:0 auto;padding:32px 28px;background:#fff;border-radius:14px;box-shadow:0 4px 24px rgba(0,0,0,0.07);">
                <h1>Sign Up</h1>
                <form id="signup-form">
                    <input type="text" id="signup-name" placeholder="Your Name" required />
                    <input type="email" id="signup-email" placeholder="Email" required />
                    <input type="password" id="signup-password" placeholder="Password" required />
                    <input type="password" id="signup-confirm" placeholder="Confirm Password" required />
                    <input type="text" id="signup-business" placeholder="Business Name" required />
                    <input type="tel" id="signup-phone" placeholder="Phone Number" required />
                    <select id="signup-role" required>
                        <option value="">Select Role</option>
                        <option value="owner">Business Owner</option>
                        <option value="client">Client</option>
                    </select>
                    <div id="signup-error" style="color:red;display:none;"></div>
                    <button type="submit" id="signup-btn">Create Account</button>
                </form>
            </div>
        </div>
    `;
            // Signup logic
            const form = document.getElementById('signup-form');
            form.onsubmit = async (e) => {
                e.preventDefault();
                const name = document.getElementById('signup-name').value.trim();
                const email = document.getElementById('signup-email').value.trim();
                const password = document.getElementById('signup-password').value;
                const confirm = document.getElementById('signup-confirm').value;
                const business = document.getElementById('signup-business').value.trim();
                const phoneRaw = document.getElementById('signup-phone').value.trim();
                const phone = phoneRaw.replace(/\s+/g, ''); // strip whitespace
                const role = document.getElementById('signup-role').value;
                const errorBox = document.getElementById('signup-error');
                errorBox.style.display = 'none';
                if (password !== confirm) {
                    errorBox.textContent = "Passwords do not match.";
                    errorBox.style.display = 'block';
                    return;
                }
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    const userData = {
                        name,
                        email,
                        phone,
                        role,
                        status: 'active',
                        createdAt: new Date().toISOString()
                    };
                    if (role === 'owner') {
                        userData.business = business;
                        userData.companyId = user.uid;
                    }
                    await setDoc(doc(db, 'users', user.uid), userData);
                    if (role === 'owner') {
                        await setDoc(doc(db, 'companies', user.uid), {
                            name: business,
                            ownerUid: user.uid,
                            ownerEmail: email,
                            ownerName: name,
                            ownerPhone: phone,
                            services: [],
                            settings: {
                                timezone: 'America/New_York',
                                bookingWindow: 30,
                                cancellationPolicy: '24 hours notice required',
                                notifications: {
                                    emailEnabled: true,
                                    smsEnabled: false
                                }
                            },
                            totalRevenue: 0,
                            createdAt: new Date().toISOString()
                        });
                    }
                    route('/dashboard');
                } catch (err) {
                    errorBox.textContent = err.message.replace('Firebase: ', '');
                    errorBox.style.display = 'block';
                }
            };
        }

        async function renderReset() {
            root.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:center;min-height:100vh;">
            <div class="login-container" style="min-width:399px;max-width:420px;margin:0 auto;padding:32px 28px;background:#fff;border-radius:14px;box-shadow:0 4px 24px rgba(0,0,0,0.07);">
                <h1>Reset Password</h1>
                <form id="reset-form">
                    <input type="email" id="reset-email" placeholder="Enter your email" required />
                    <div id="reset-error" style="color:red;display:none;"></div>
                    <button type="submit" id="reset-btn">Send Reset Email</button>
                </form>
            </div>
        </div>
    `;
            // Reset logic
            const form = document.getElementById('reset-form');
            form.onsubmit = async (e) => {
                e.preventDefault();
                const email = document.getElementById('reset-email').value.trim();
                const errorBox = document.getElementById('reset-error');
                errorBox.style.display = 'none';
                try {
                    await sendPasswordResetEmail(auth, email);
                    errorBox.textContent = "Password reset email sent.";
                    errorBox.style.color = '#1976d2';
                    errorBox.style.display = 'block';
                } catch (err) {
                    errorBox.textContent = err.message.replace('Firebase: ', '');
                    errorBox.style.color = '#c62828';
                    errorBox.style.display = 'block';
                }
            };
        }

        // Week navigation functions
        function changeWeek(direction) {
            currentWeekOffset += direction;
            renderDashboard(); // Re-render to update calendar
        }

        function getWeekStartDate() {
            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay() + (currentWeekOffset * 7)); // Sunday
            return startOfWeek;
        }

        function formatWeekDisplay() {
            const startOfWeek = getWeekStartDate();
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);

            const options = { month: 'short', day: 'numeric' };
            const startStr = startOfWeek.toLocaleDateString('en-US', options);
            const endStr = endOfWeek.toLocaleDateString('en-US', options);

            if (currentWeekOffset === 0) {
                return `This Week (${startStr} - ${endStr})`;
            } else if (currentWeekOffset === -1) {
                return `Last Week (${startStr} - ${endStr})`;
            } else if (currentWeekOffset === 1) {
                return `Next Week (${startStr} - ${endStr})`;
            } else {
                return `Week of ${startStr} - ${endStr}`;
            }
        }

        async function renderDashboard() {
            if (currentRole === 'owner') {
                // Fetch owner's company
                const companiesRef = collection(db, "companies");
                const q = query(companiesRef, where('ownerUid', '==', currentUser.uid));
                const querySnapshot = await getDocs(q);
                let companyDoc = null;
                let companyId = null;
                if (!querySnapshot.empty) {
                    companyDoc = querySnapshot.docs[0].data();
                    companyId = querySnapshot.docs[0].id;
                }

                // Fetch services
                let services = Array.isArray(companyDoc?.services) ? companyDoc.services : [];

                // Fetch clients for this company (from subcollection)
                let clients = [];
                if (companyId) {
                    const clientsSnap = await getDocs(collection(db, "companies", companyId, "clients"));
                    clientsSnap.forEach(docSnap => {
                        clients.push({ id: docSnap.id, ...docSnap.data() });
                    });
                }

                // Fetch real bookings from Firestore BEFORE rendering
                let bookings = [];
                if (companyId) {
                    try {
                        const bookingsSnapshot = await getDocs(collection(db, 'companies', companyId, 'bookings'));
                        const startOfWeek = getWeekStartDate(); // Use the selected week

                        bookingsSnapshot.forEach(docSnap => {
                            const booking = docSnap.data();
                            if (!booking.date || !booking.startTime) return; // Skip malformed bookings

                            const bookingDate = new Date(booking.date);

                            // Calculate day offset from start of selected week
                            const dayDiff = Math.floor((bookingDate - startOfWeek) / (1000 * 60 * 60 * 24));

                            if (dayDiff >= 0 && dayDiff < 7) {
                                const hour = parseInt(booking.startTime.split(':')[0]);
                                if (!isNaN(hour)) {
                                    bookings.push({
                                        id: docSnap.id,
                                        day: dayDiff,
                                        hour: hour,
                                        client: booking.clientName || 'Unknown Client',
                                        service: booking.serviceName || 'Unknown Service',
                                        status: booking.status || 'scheduled',
                                        ...booking
                                    });
                                }
                            }
                        });
                    } catch (err) {
                        console.error('Error fetching bookings:', err);
                        // Fallback to demo booking for testing
                        bookings = [];
                    }
                }

                root.innerHTML = `
<div class="container">
    ${renderSidebar()}
    <main class="main">
        <header class="topbar">
            <h1>Dashboard</h1>
            <div class="user-box" id="user-box">
                <button id="auth-btn">Sign Out</button>
            </div>
        </header>
        <section class="content" id="dashboard-content">
            <!-- Company Info -->
            <div class="card" style="padding:28px 24px;margin-bottom:28px;">
                <h2 style="margin-bottom:10px;">${companyDoc?.name || 'Unnamed Company'}</h2>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:18px;">
                    <div>
                        <span style="font-weight:600;color:#4f46e5;">Owner:</span> ${companyDoc?.ownerName || 'Unknown'}
                    </div>
                    <div>
                        <span style="font-weight:600;color:#4f46e5;">Phone:</span> ${formatPhone(companyDoc?.ownerPhone) || 'N/A'}
                    </div>
                    <div>
                        <span style="font-weight:600;color:#4f46e5;">Email:</span> ${companyDoc?.ownerEmail || 'N/A'}
                    </div>
                </div>
            </div>
            <!-- Booking Section -->
            <div class="card" style="padding:28px 24px;margin-bottom:28px;">
                <h2 style="margin-bottom:16px;">Bookings Calendar</h2>
                
                <!-- Week Navigation -->
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding:12px 16px;background:#f8fafc;border-radius:8px;">
                    <button onclick="changeWeek(-1)" style="padding:8px 16px;background:#4f46e5;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:500;">← Previous Week</button>
                    <div id="week-display" style="font-weight:600;color:#374151;font-size:1.1em;">Current Week</div>
                    <button onclick="changeWeek(1)" style="padding:8px 16px;background:#4f46e5;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:500;">Next Week →</button>
                </div>
                
                <div id="booking-calendar" style="overflow-x:auto;"></div>
            </div>
            <!-- Recent Bookings Section -->
            <div class="card" style="padding:28px 24px;margin-bottom:28px;">
                <h2 style="margin-bottom:16px;">Recent Bookings</h2>
                <div id="bookings-list">
                    ${bookings.length === 0 ? '<p style="color:#888;">No bookings yet.</p>' : ''}
                    ${bookings.slice(0, 5).map(booking => `
                        <div style="background:#f8fafc;padding:16px;border-radius:8px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;">
                            <div>
                                <div style="font-weight:600;color:#222;">${booking.client}</div>
                                <div style="color:#666;font-size:0.95em;">${booking.service} - ${formatDate(booking.date || new Date().toISOString())} at ${booking.startTime ? formatTimeString12Hour(booking.startTime) : formatTime12Hour(booking.hour)}</div>
                            </div>
                            <div>
                                <span style="background:${booking.status === 'scheduled' ? '#e3f2fd' : booking.status === 'completed' ? '#e8f5e8' : '#ffebee'};color:${booking.status === 'scheduled' ? '#1976d2' : booking.status === 'completed' ? '#2e7d32' : '#d32f2f'};padding:4px 12px;border-radius:12px;font-size:0.85em;font-weight:500;">${booking.status || 'scheduled'}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
            <!-- Services Section -->
            <div class="card" style="padding:28px 24px;margin-bottom:28px;">
                <h2 style="margin-bottom:16px;">Services & Prices</h2>
                <form id="services-form">
                    <table style="width:100%;margin-top:8px;border-collapse:separate;border-spacing:0 10px;">
                        <thead>
                            <tr>
                                <th style="text-align:left;padding:10px 8px;color:#4f46e5;font-size:1.08em;">Service</th>
                                <th style="text-align:left;padding:10px 8px;color:#4f46e5;font-size:1.08em;">Price</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="services-table-body">
                            ${services.length === 0 ? '<tr><td colspan="3" style="color:#888;">No services listed.</td></tr>' : services.map((s, idx) => `
                                <tr style="background:#f8fafc;">
                                    <td style="padding:10px 8px;border-radius:6px 0 0 6px;">${s.name}</td>
                                    <td style="padding:10px 8px;border-radius:0 6px 6px 0;">$${s.price}</td>
                                    <td style="text-align:center;">
                                        <button type="button" class="remove-service-btn" data-idx="${idx}"
                                            style="
                                                background:#fff;
                                                border:none;
                                                border-radius:12px;
                                                width:32px;
                                                height:32px;
                                                box-shadow:0 1px 4px rgba(0,0,0,0.07);
                                                display:flex;
                                                align-items:center;
                                                justify-content:center;
                                                cursor:pointer;
                                                transition:background 0.18s;
                                                padding:0;
                                            "
                                            onmouseover="this.style.background='#ffeaea'"
                                            onmouseout="this.style.background='#fff'"
                                            aria-label="Remove service"
                                        >
                                            <svg width="18" height="18" viewBox="0 0 18 18" fill="none" style="display:block;" xmlns="http://www.w3.org/2000/svg">
                                                <rect x="4.2" y="3.8" width="9.6" height="9.6" rx="4.8" fill="#fff"/>
                                                <path d="M6 6L12 12M12 6L6 12" stroke="#e53935" stroke-width="2.2" stroke-linecap="round"/>
                                            </svg>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                            <tr style="background:#f8fafc;">
                                <td style="padding:10px 8px;">
                                    <input type="text" id="new-service-name" placeholder="Service name" style="width:90%;padding:8px 12px;border-radius:10px;border:1px solid #e5e7eb;font-size:1em;">
                                </td>
                                <td style="padding:10px 8px;">
                                    <input type="number" id="new-service-price" placeholder="Price" style="width:70%;padding:8px 12px;border-radius:10px;border:1px solid #e5e7eb;font-size:1em;">
                                </td>
                                <td style="text-align:center;">
                                    <button type="button" id="add-service-btn"
                                        style="
                                            background:#fff;
                                            border:none;
                                            border-radius:12px;
                                            width:32px;
                                            height:32px;
                                            box-shadow:0 1px 4px rgba(0,0,0,0.07);
                                            display:flex;
                                            align-items:center;
                                            justify-content:center;
                                            cursor:pointer;
                                            transition:background 0.18s;
                                            padding:0;
                                        "
                                        onmouseover="this.style.background='#e6faed'"
                                        onmouseout="this.style.background='#fff'"
                                        aria-label="Add service"
                                    >
                                        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" style="display:block;" xmlns="http://www.w3.org/2000/svg">
                                            <rect x="4.2" y="3.8" width="9.6" height="9.6" rx="4.8" fill="#fff"/>
                                            <path d="M9 6V12M6 9H12" stroke="#22c55e" stroke-width="2.2" stroke-linecap="round"/>
                                        </svg>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div id="services-error" style="color:#c62828;display:none;font-size:0.98em;margin-top:8px;"></div>
                </form>
            </div>
            <!-- Clients Section -->
            <div class="card" style="padding:28px 24px;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <h2 style="margin-bottom:0;">Clients</h2>
                    <button id="add-client-btn" style="padding:10px 22px;border-radius:7px;background:#4f46e5;color:#fff;font-weight:600;border:none;cursor:pointer;">+ Add Client</button>
                </div>
                <div style="overflow-x:auto;">
                    <table style="width:100%;margin-top:18px;border-collapse:separate;border-spacing:0 10px;">
                        <thead>
                            <tr>
                                <th style="text-align:left;padding:10px 8px;color:#4f46e5;">Name</th>
                                <th style="text-align:left;padding:10px 8px;color:#4f46e5;">Email</th>
                                <th style="text-align:left;padding:10px 8px;color:#4f46e5;">Phone</th>
                                <th style="text-align:left;padding:10px 8px;color:#4f46e5;">Address</th>
                                <th style="text-align:left;padding:10px 8px;color:#4f46e5;">Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${clients.length === 0 ? '<tr><td colspan="5" style="color:#888;">No clients yet.</td></tr>' : clients.map(client => `
                                <tr style="background:#f8fafc;">
                                    <td style="padding:10px 8px;border-radius:6px 0 0 6px;">${client.name}</td>
                                    <td style="padding:10px 8px;">${client.email}</td>
                                    <td style="padding:10px 8px;">${formatPhone(client.phone)}</td>
                                    <td style="padding:10px 8px;">${typeof client.address === 'object' ? client.address?.street || '' : client.address || ''}</td>
                                    <td style="padding:10px 8px;border-radius:0 6px 6px 0;">${client.notes || ''}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>
</div>
<div id="add-client-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:1002;align-items:center;justify-content:center;">
    <div style="background:#fff;padding:32px 28px;border-radius:14px;box-shadow:0 4px 24px rgba(0,0,0,0.09);max-width:420px;width:100%;margin:auto;">
        <h2 style="margin-bottom:18px;font-size:1.2em;font-weight:700;text-align:center;">Add Client</h2>
        <form id="add-client-form" style="display:flex;flex-direction:column;gap:14px;">
            <input type="text" id="client-name" placeholder="Client Name" required style="padding:11px 13px;border-radius:7px;border:1px solid #e5e7eb;">
            <input type="email" id="client-email" placeholder="Email" required style="padding:11px 13px;border-radius:7px;border:1px solid #e5e7eb;">
            <input type="tel" id="client-phone" placeholder="Phone Number" required style="padding:11px 13px;border-radius:7px;border:1px solid #e5e7eb;">
            <input type="text" id="client-address" placeholder="Address" style="padding:11px 13px;border-radius:7px;border:1px solid #e5e7eb;">
            <textarea id="client-notes" placeholder="Notes" style="padding:11px 13px;border-radius:7px;border:1px solid #e5e7eb;min-height:60px;"></textarea>
            <div id="add-client-error" style="color:#c62828;display:none;font-size:0.98em;"></div>
            <button type="submit" style="padding:12px 0;border-radius:7px;background:#4f46e5;color:#fff;font-size:1.08em;font-weight:600;border:none;cursor:pointer;">Add Client</button>
        </form>
        <button id="add-client-modal-close" style="display:block;margin:0 auto;margin-top:10px;background:none;border:none;color:#888;font-size:1.1em;cursor:pointer;">Cancel</button>
    </div>
</div>
`;

                document.getElementById('auth-btn').onclick = () => signOut(auth);

                // Service editing logic
                document.querySelectorAll('.remove-service-btn').forEach(btn => {
                    btn.onclick = async () => {
                        const idx = parseInt(btn.getAttribute('data-idx'));
                        const updated = services.slice();
                        updated.splice(idx, 1);
                        try {
                            await updateDoc(doc(db, "companies", companyId), { services: updated });
                            renderDashboard();
                        } catch (err) {
                            const errBox = document.getElementById('services-error');
                            errBox.textContent = err.message.replace('Firebase: ', '');
                            errBox.style.display = 'block';
                        }
                    };
                });
                document.getElementById('add-service-btn').onclick = async () => {
                    if (!hasPermission('manage_company', companyId)) {
                        alert('You do not have permission to add services.');
                        return;
                    }

                    const name = document.getElementById('new-service-name').value.trim();
                    const price = document.getElementById('new-service-price').value.trim();
                    const errBox = document.getElementById('services-error');
                    errBox.style.display = 'none';
                    if (!name || !price || isNaN(price)) {
                        errBox.textContent = "Please enter a valid service name and price.";
                        errBox.style.display = 'block';
                        return;
                    }

                    const newService = {
                        id: generateId(),
                        name,
                        price: Number(price),
                        duration: 60, // Default 1 hour
                        description: '',
                        active: true
                    };
                    const updated = services.concat([newService]);
                    try {
                        await updateDoc(doc(db, "companies", companyId), { services: updated });
                        renderDashboard();
                    } catch (err) {
                        errBox.textContent = err.message.replace('Firebase: ', '');
                        errBox.style.display = 'block';
                    }
                };

                // Add client modal logic
                const modal = document.getElementById('add-client-modal');
                document.getElementById('add-client-btn').onclick = () => {
                    modal.style.display = 'flex';
                };
                document.getElementById('add-client-modal-close').onclick = () => {
                    modal.style.display = 'none';
                    document.getElementById('add-client-error').style.display = 'none';
                };
                document.getElementById('add-client-form').onsubmit = async (e) => {
                    e.preventDefault();

                    if (!hasPermission('manage_clients', companyId)) {
                        alert('You do not have permission to add clients.');
                        return;
                    }

                    const name = document.getElementById('client-name').value.trim();
                    const email = document.getElementById('client-email').value.trim();
                    const phoneRaw = document.getElementById('client-phone').value.trim();
                    const phone = phoneRaw.replace(/\s+/g, '');
                    const addressStr = document.getElementById('client-address').value.trim();
                    const notes = document.getElementById('client-notes').value.trim();
                    const errorBox = document.getElementById('add-client-error');
                    errorBox.style.display = 'none';

                    if (!name || !email || !phone) {
                        errorBox.textContent = "Name, email, and phone are required.";
                        errorBox.style.display = 'block';
                        return;
                    }

                    try {
                        // Parse address if provided
                        let address = { street: '', city: '', state: '', zipCode: '' };
                        if (addressStr) {
                            address.street = addressStr; // Simple implementation - could be enhanced
                        }

                        // Store client in company's subcollection
                        await addDoc(collection(db, 'companies', companyId, 'clients'), {
                            name,
                            email,
                            phone,
                            address,
                            notes,
                            status: 'active',
                            totalBookings: 0,
                            lastBooking: null,
                            createdAt: new Date().toISOString()
                        });
                        modal.style.display = 'none';
                        renderDashboard();
                    } catch (err) {
                        errorBox.textContent = err.message.replace('Firebase: ', '');
                        errorBox.style.display = 'block';
                    }
                };

                // Render booking calendar for business owner
                // Fetch availability from companyDoc
                let availability = Array.isArray(companyDoc?.availability) ? companyDoc.availability : [
                    { day: 'Sunday', enabled: false, start: '09:00', end: '17:00' },
                    { day: 'Monday', enabled: true, start: '09:00', end: '17:00' },
                    { day: 'Tuesday', enabled: true, start: '09:00', end: '17:00' },
                    { day: 'Wednesday', enabled: true, start: '09:00', end: '17:00' },
                    { day: 'Thursday', enabled: true, start: '09:00', end: '17:00' },
                    { day: 'Friday', enabled: true, start: '09:00', end: '17:00' },
                    { day: 'Saturday', enabled: false, start: '09:00', end: '17:00' },
                ];

                // Build calendar grid
                const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                const startOfWeek = getWeekStartDate();

                // Update week display
                const weekDisplayElement = document.getElementById('week-display');
                if (weekDisplayElement) {
                    weekDisplayElement.textContent = formatWeekDisplay();
                }

                let calendarHtml = '<table style="border-collapse:separate;width:100%;min-width:700px;">';
                // Header row with sticky th
                calendarHtml += '<thead><tr><th style="width:48px;position:sticky;top:0;z-index:3;background:#fff;"></th>';
                for (let d = 0; d < 7; d++) {
                    const currentDate = new Date(startOfWeek);
                    currentDate.setDate(startOfWeek.getDate() + d);
                    const dateStr = currentDate.getDate();
                    const isToday = currentDate.toDateString() === new Date().toDateString();
                    const todayStyle = isToday ? 'background:#4f46e5;color:white;' : 'background:#f3f4f6;color:#4f46e5;';
                    calendarHtml += `<th style="text-align:center;padding:6px 0;font-weight:700;${todayStyle}position:sticky;top:0;z-index:2;">
                        <div>${days[d]}</div>
                        <div style="font-size:0.9em;font-weight:500;">${dateStr}</div>
                    </th>`;
                }
                calendarHtml += '</tr></thead><tbody>';
                let firstAvailRow = null;
                for (let h = 0; h < 24; h++) {
                    let rowHasAvail = false;
                    let rowHtml = `<tr>`;
                    // Hour label
                    rowHtml += `<td style="text-align:right;padding:2px 8px;color:#888;font-size:0.98em;background:#f3f4f6;">${formatTime12Hour(h)}</td>`;
                    for (let d = 0; d < 7; d++) {
                        // Is this hour available?
                        const avail = availability[d];
                        let isAvailable = false;
                        if (avail.enabled) {
                            const startH = parseInt(avail.start.split(':')[0], 10);
                            const endH = parseInt(avail.end.split(':')[0], 10);
                            isAvailable = h >= startH && h < endH;
                        }
                        // Check for a booking tile (static demo for now)
                        const booking = bookings.find(b => b.day === d && b.hour === h);
                        // 'Active' (available) cells are determined by business owner's set availability, not hardcoded
                        let cellStyle = `padding:0;height:64px;min-width:80px;`;
                        let cellClass = '';
                        if (isAvailable) {
                            cellClass = 'modern-available';
                            rowHasAvail = true;
                        } else {
                            cellClass = 'modern-unavailable';
                        }
                        rowHtml += `<td class="${cellClass}" style="${cellStyle}position:relative;">`;
                        if (booking) {
                            rowHtml += `<div class="booking-tile" data-day="${d}" data-hour="${h}" style="position:absolute;top:2px;left:2px;right:2px;bottom:2px;background:#4f46e5;color:#fff;border-radius:7px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:1.08em;font-weight:600;box-shadow:0 2px 8px rgba(79,70,229,0.10);z-index:1;cursor:pointer;line-height:1.32;padding:0 6px;min-height:56px;">
                                <span style='font-size:1em;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;width:100%;text-align:center;'>${booking.client}</span>
                                <span style='font-size:0.97em;font-weight:400;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;width:100%;text-align:center;'>${booking.service}</span>
                            </div>`;
                        }
                        rowHtml += `</td>`;
                    }
                    rowHtml += `</tr>`;
                    if (firstAvailRow === null && rowHasAvail) firstAvailRow = h;
                    calendarHtml += rowHtml;
                }
                calendarHtml += '</tbody></table>';
                // Make calendar scrollable and set scroll position
                document.getElementById('booking-calendar').innerHTML = `<div id='calendar-scroll-wrap' style='max-height:700px;overflow-y:auto;position:relative;'>${calendarHtml}</div>`;
                setTimeout(() => {
                    const wrap = document.getElementById('calendar-scroll-wrap');
                    if (wrap && firstAvailRow !== null) {
                        // Each row is about 48px + border spacing, scroll to first available
                        wrap.scrollTop = Math.max(0, (firstAvailRow - 2) * 52);
                    }
                }, 0);

                // --- Booking Management Modal (Business Owner) ---
                // Modal HTML (hidden by default, append only once)
                let bookingModal = document.getElementById('booking-modal');
                if (!bookingModal) {
                    bookingModal = document.createElement('div');
                    bookingModal.id = 'booking-modal';
                    bookingModal.style.display = 'none';
                    bookingModal.style.position = 'fixed';
                    bookingModal.style.top = '0';
                    bookingModal.style.left = '0';
                    bookingModal.style.width = '100vw';
                    bookingModal.style.height = '100vh';
                    bookingModal.style.background = 'rgba(0,0,0,0.18)';
                    bookingModal.style.zIndex = '1003';
                    bookingModal.style.alignItems = 'center';
                    bookingModal.style.justifyContent = 'center';
                    bookingModal.innerHTML = `
                        <div id="booking-modal-content" style="background:#fff;padding:32px 28px;border-radius:14px;box-shadow:0 4px 24px rgba(0,0,0,0.09);max-width:420px;width:100%;margin:auto;min-height:120px;display:flex;flex-direction:column;gap:18px;">
                            <div id="booking-modal-details"></div>
                            <div id="booking-modal-error" style="color:#c62828;display:none;font-size:0.98em;"></div>
                            <div style="display:flex;gap:16px;justify-content:flex-end;">
                                <button id="booking-modal-cancel-btn" style="padding:10px 18px;border-radius:7px;background:#e53935;color:#fff;font-weight:600;border:none;cursor:pointer;">Cancel Booking</button>
                                <button id="booking-modal-close-btn" style="padding:10px 18px;border-radius:7px;background:#f3f4f6;color:#4f46e5;font-weight:600;border:none;cursor:pointer;">Close</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(bookingModal);
                }

                // Click handlers for booking tiles and available slots (attach after DOM insertion)
                setTimeout(() => {
                    // Booking tile click: show manage modal
                    document.querySelectorAll('.booking-tile').forEach(tile => {
                        tile.onclick = () => {
                            const day = parseInt(tile.getAttribute('data-day'));
                            const hour = parseInt(tile.getAttribute('data-hour'));
                            const booking = bookings.find(b => b.day === day && b.hour === hour);
                            if (!booking) return;
                            document.getElementById('booking-modal-details').innerHTML = `
                                <div style='font-size:1.1em;font-weight:600;margin-bottom:6px;'>${booking.service}</div>
                                <div><span style='color:#4f46e5;font-weight:500;'>Client:</span> ${booking.client}</div>
                                <div><span style='color:#4f46e5;font-weight:500;'>Day:</span> ${days[day]}</div>
                                <div><span style='color:#4f46e5;font-weight:500;'>Time:</span> ${hour}:00</div>
                            `;
                            document.getElementById('booking-modal-error').style.display = 'none';
                            bookingModal.style.display = 'flex';
                            document.getElementById('booking-modal-cancel-btn').onclick = async () => {
                                document.getElementById('booking-modal-error').textContent = 'Cancel booking logic not yet implemented.';
                                document.getElementById('booking-modal-error').style.display = 'block';
                            };
                            document.getElementById('booking-modal-close-btn').onclick = () => {
                                bookingModal.style.display = 'none';
                            };
                        };
                    });

                    // Available slot click: show add modal if no booking
                    document.querySelectorAll('#booking-calendar td.modern-available').forEach(cell => {
                        // Only attach if no booking-tile inside
                        if (!cell.querySelector('.booking-tile')) {
                            cell.style.cursor = 'pointer';
                            cell.onclick = () => {
                                // Find day/hour from cell position
                                const row = cell.parentElement;
                                const tbody = row.parentElement;
                                const hour = Array.from(tbody.children).indexOf(row);
                                const day = Array.from(row.children).indexOf(cell) - 1; // -1 for hour label
                                // Show add booking modal
                                showAddBookingModal(day, hour);
                            };
                        }
                    });
                }, 0);

                // Add Booking Modal (only one instance, with dropdowns)
                let addBookingModal = document.getElementById('add-booking-modal');
                if (!addBookingModal) {
                    addBookingModal = document.createElement('div');
                    addBookingModal.id = 'add-booking-modal';
                    addBookingModal.style.display = 'none';
                    addBookingModal.style.position = 'fixed';
                    addBookingModal.style.top = '0';
                    addBookingModal.style.left = '0';
                    addBookingModal.style.width = '100vw';
                    addBookingModal.style.height = '100vh';
                    addBookingModal.style.background = 'rgba(0,0,0,0.18)';
                    addBookingModal.style.zIndex = '1004';
                    addBookingModal.style.alignItems = 'center';
                    addBookingModal.style.justifyContent = 'center';
                    addBookingModal.innerHTML = `
                        <div id="add-booking-modal-content" style="background:#fff;padding:32px 28px;border-radius:14px;box-shadow:0 4px 24px rgba(0,0,0,0.09);max-width:420px;width:100%;margin:auto;min-height:120px;display:flex;flex-direction:column;gap:18px;">
                            <div id="add-booking-modal-details"></div>
                            <div id="add-booking-modal-error" style="color:#c62828;display:none;font-size:0.98em;"></div>
                            <form id="add-booking-form" style="display:flex;flex-direction:column;gap:12px;">
                                <select id="add-booking-client" required style="padding:10px 12px;border-radius:7px;border:1px solid #e5e7eb;"></select>
                                <select id="add-booking-service" required style="padding:10px 12px;border-radius:7px;border:1px solid #e5e7eb;"></select>
                                <div style="display:flex;gap:16px;justify-content:flex-end;margin-top:8px;">
                                    <button type="submit" style="padding:10px 18px;border-radius:7px;background:#4f46e5;color:#fff;font-weight:600;border:none;cursor:pointer;">Add Booking</button>
                                    <button type="button" id="add-booking-modal-close-btn" style="padding:10px 18px;border-radius:7px;background:#f3f4f6;color:#4f46e5;font-weight:600;border:none;cursor:pointer;">Cancel</button>
                                </div>
                            </form>
                        </div>
                    `;
                    document.body.appendChild(addBookingModal);
                }

                // New Client Modal (only one instance)
                let newClientModal = document.getElementById('new-client-modal');
                if (!newClientModal) {
                    newClientModal = document.createElement('div');
                    newClientModal.id = 'new-client-modal';
                    newClientModal.style.display = 'none';
                    newClientModal.style.position = 'fixed';
                    newClientModal.style.top = '0';
                    newClientModal.style.left = '0';
                    newClientModal.style.width = '100vw';
                    newClientModal.style.height = '100vh';
                    newClientModal.style.background = 'rgba(0,0,0,0.18)';
                    newClientModal.style.zIndex = '1005';
                    newClientModal.style.alignItems = 'center';
                    newClientModal.style.justifyContent = 'center';
                    newClientModal.innerHTML = `
                        <div id="new-client-modal-content" style="background:#fff;padding:32px 28px;border-radius:14px;box-shadow:0 4px 24px rgba(0,0,0,0.09);max-width:420px;width:100%;margin:auto;min-height:120px;display:flex;flex-direction:column;gap:18px;">
                            <div style='font-size:1.1em;font-weight:600;margin-bottom:6px;'>Add New Client</div>
                            <div id="new-client-modal-error" style="color:#c62828;display:none;font-size:0.98em;"></div>
                            <form id="new-client-form" style="display:flex;flex-direction:column;gap:12px;">
                                <input id="new-client-name" type="text" placeholder="Name" required style="padding:10px 12px;border-radius:7px;border:1px solid #e5e7eb;" />
                                <input id="new-client-email" type="email" placeholder="Email" required style="padding:10px 12px;border-radius:7px;border:1px solid #e5e7eb;" />
                                <input id="new-client-phone" type="tel" placeholder="Phone" required style="padding:10px 12px;border-radius:7px;border:1px solid #e5e7eb;" />
                                <input id="new-client-address" type="text" placeholder="Address" style="padding:10px 12px;border-radius:7px;border:1px solid #e5e7eb;" />
                                <textarea id="new-client-notes" placeholder="Notes" style="padding:10px 12px;border-radius:7px;border:1px solid #e5e7eb;min-height:60px;"></textarea>
                                <div style="display:flex;gap:16px;justify-content:flex-end;margin-top:8px;">
                                    <button type="submit" style="padding:10px 18px;border-radius:7px;background:#4f46e5;color:#fff;font-weight:600;border:none;cursor:pointer;">Add Client</button>
                                    <button type="button" id="new-client-modal-close-btn" style="padding:10px 18px;border-radius:7px;background:#f3f4f6;color:#4f46e5;font-weight:600;border:none;cursor:pointer;">Cancel</button>
                                </div>
                            </form>
                        </div>
                    `;
                    document.body.appendChild(newClientModal);
                }

                // Show Add Booking Modal function (with dropdowns)
                async function showAddBookingModal(day, hour) {
                    // Store selected day and hour for form submission
                    showAddBookingModal.selectedDay = day;
                    showAddBookingModal.selectedHour = hour;

                    const startOfWeek = getWeekStartDate();
                    const selectedDate = new Date(startOfWeek);
                    selectedDate.setDate(startOfWeek.getDate() + day);
                    const dateStr = selectedDate.toLocaleDateString('en-US', {
                        weekday: 'long',
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    });

                    document.getElementById('add-booking-modal-details').innerHTML = `
                        <div style='font-size:1.1em;font-weight:600;margin-bottom:6px;'>Add Booking</div>
                        <div><span style='color:#4f46e5;font-weight:500;'>Date:</span> ${dateStr}</div>
                        <div><span style='color:#4f46e5;font-weight:500;'>Time:</span> ${formatTime12Hour(hour)}</div>
                    `;
                    document.getElementById('add-booking-modal-error').style.display = 'none';
                    addBookingModal.style.display = 'flex';

                    // Fetch clients from Firestore
                    let clientOptions = [];
                    try {
                        const clientsSnap = await getDocs(collection(db, 'companies', companyId, 'clients'));
                        clientsSnap.forEach(docSnap => {
                            const data = docSnap.data();
                            clientOptions.push({ id: docSnap.id, name: data.name });
                        });
                    } catch (err) {
                        // fallback: no clients
                    }
                    // Populate client dropdown
                    const clientSelect = document.getElementById('add-booking-client');
                    clientSelect.innerHTML = clientOptions.map(c => `<option value="${c.id}">${c.name}</option>`).join('') + '<option value="__new__">+ New Client</option>';
                    clientSelect.value = clientOptions.length ? clientOptions[0].id : '__new__';

                    // Fetch services from Firestore
                    let serviceOptions = Array.isArray(services) ? services.filter(s => s.active !== false) : [];
                    const serviceSelect = document.getElementById('add-booking-service');
                    serviceSelect.innerHTML = serviceOptions.map(s => `<option value="${s.id || s.name}">${s.name} - $${s.price}</option>`).join('');
                    serviceSelect.value = serviceOptions.length ? (serviceOptions[0].id || serviceOptions[0].name) : '';

                    // Show new client modal if selected
                    clientSelect.onchange = () => {
                        if (clientSelect.value === '__new__') {
                            addBookingModal.style.display = 'none';
                            showNewClientModal(async (newClientId, newClientName) => {
                                // After adding, re-show booking modal and select new client
                                await showAddBookingModal(day, hour);
                                document.getElementById('add-booking-client').value = newClientId;
                            });
                        }
                    };

                    // Close handler
                    document.getElementById('add-booking-modal-close-btn').onclick = () => {
                        addBookingModal.style.display = 'none';
                    };
                    // Form submit handler
                    document.getElementById('add-booking-form').onsubmit = async (e) => {
                        e.preventDefault();

                        if (!hasPermission('manage_bookings', companyId)) {
                            alert('You do not have permission to create bookings.');
                            return;
                        }

                        const clientId = clientSelect.value;
                        const serviceId = serviceSelect.value;
                        const errorBox = document.getElementById('add-booking-modal-error');
                        errorBox.style.display = 'none';

                        if (!clientId || !serviceId) {
                            errorBox.textContent = 'Client and service are required.';
                            errorBox.style.display = 'block';
                            return;
                        }

                        if (clientId === '__new__') {
                            errorBox.textContent = 'Please add/select a client.';
                            errorBox.style.display = 'block';
                            return;
                        }

                        try {
                            // Get client and service details
                            const selectedClient = clientOptions.find(c => c.id === clientId);
                            const selectedService = serviceOptions.find(s => s.id === serviceId);

                            if (!selectedClient || !selectedService) {
                                throw new Error('Invalid client or service selection');
                            }

                            // Calculate booking time using selected week
                            const day = showAddBookingModal.selectedDay;
                            const hour = showAddBookingModal.selectedHour;
                            const startOfWeek = getWeekStartDate();
                            const bookingDate = new Date(startOfWeek);
                            bookingDate.setDate(startOfWeek.getDate() + day);

                            const startTime = `${hour.toString().padStart(2, '0')}:00`;
                            const endHour = hour + Math.floor(selectedService.duration / 60);
                            const endMinutes = selectedService.duration % 60;
                            const endTime = `${endHour.toString().padStart(2, '0')}:${endMinutes.toString().padStart(2, '0')}`;

                            // Create booking document
                            const bookingData = {
                                clientId: clientId,
                                clientName: selectedClient.name,
                                serviceId: selectedService.id,
                                serviceName: selectedService.name,
                                date: bookingDate.toISOString().split('T')[0], // YYYY-MM-DD
                                startTime: startTime,
                                endTime: endTime,
                                duration: selectedService.duration,
                                status: 'scheduled',
                                price: selectedService.price,
                                notes: '',
                                createdAt: new Date().toISOString(),
                                updatedAt: new Date().toISOString()
                            };

                            // Save to Firestore
                            await addDoc(collection(db, 'companies', companyId, 'bookings'), bookingData);

                            // Update client's booking count
                            await updateDoc(doc(db, 'companies', companyId, 'clients', clientId), {
                                totalBookings: (selectedClient.totalBookings || 0) + 1,
                                lastBooking: bookingData.date
                            });

                            addBookingModal.style.display = 'none';
                            renderDashboard();
                        } catch (err) {
                            errorBox.textContent = err.message.replace('Firebase: ', '');
                            errorBox.style.display = 'block';
                        }
                    };
                }

                // Show New Client Modal function
                function showNewClientModal(onAdded) {
                    document.getElementById('new-client-modal-error').style.display = 'none';
                    newClientModal.style.display = 'flex';
                    document.getElementById('new-client-name').value = '';
                    document.getElementById('new-client-email').value = '';
                    document.getElementById('new-client-phone').value = '';
                    document.getElementById('new-client-address').value = '';
                    document.getElementById('new-client-notes').value = '';
                    document.getElementById('new-client-modal-close-btn').onclick = () => {
                        newClientModal.style.display = 'none';
                    };
                    document.getElementById('new-client-form').onsubmit = async (e) => {
                        e.preventDefault();

                        if (!hasPermission('manage_clients', companyId)) {
                            alert('You do not have permission to add clients.');
                            return;
                        }

                        const name = document.getElementById('new-client-name').value.trim();
                        const email = document.getElementById('new-client-email').value.trim();
                        const phone = document.getElementById('new-client-phone').value.trim();
                        const addressStr = document.getElementById('new-client-address').value.trim();
                        const notes = document.getElementById('new-client-notes').value.trim();
                        const errorBox = document.getElementById('new-client-modal-error');
                        errorBox.style.display = 'none';

                        if (!name || !email || !phone) {
                            errorBox.textContent = 'Name, email, and phone are required.';
                            errorBox.style.display = 'block';
                            return;
                        }

                        try {
                            // Parse address if provided
                            let address = { street: '', city: '', state: '', zipCode: '' };
                            if (addressStr) {
                                address.street = addressStr; // Simple implementation
                            }

                            // Add to Firestore
                            const docRef = await addDoc(collection(db, 'companies', companyId, 'clients'), {
                                name,
                                email,
                                phone,
                                address,
                                notes,
                                status: 'active',
                                totalBookings: 0,
                                lastBooking: null,
                                createdAt: new Date().toISOString()
                            });
                            newClientModal.style.display = 'none';
                            if (onAdded) onAdded(docRef.id, name);
                        } catch (err) {
                            errorBox.textContent = err.message.replace('Firebase: ', '');
                            errorBox.style.display = 'block';
                        }
                    };
                }

                // Modern calendar cell styles (minimal, modern look)
                const styleId = 'modern-booking-calendar-style';
                let styleTag = document.getElementById(styleId);
                if (!styleTag) {
                    styleTag = document.createElement('style');
                    styleTag.id = styleId;
                    document.head.appendChild(styleTag);
                }
                styleTag.textContent = `
                    #calendar-scroll-wrap thead th {
                        position: sticky;
                        top: 0;
                        z-index: 2;
                        background: #f3f4f6;
                    }
                    #calendar-scroll-wrap thead th:first-child {
                        background: #fff;
                        z-index: 3;
                    }
                    #booking-calendar table {
                        border-collapse: separate !important;
                        border-spacing: 8px 4px !important;
                        background: none;
                    }
                    #booking-calendar th, #booking-calendar td {
                        border: none !important;
                        box-shadow: none !important;
                    }
                    #booking-calendar td.modern-available {
                        background: #e3f0ff; /* Soft pastel blue */
                        color: #2563eb;
                        border-radius: 11px;
                        box-shadow: 0 4px 18px 0 rgba(51, 132, 255, 0.10), 0 1.5px 4px 0 rgba(51, 132, 255, 0.07);
                        opacity: 1;
                        transition: box-shadow 0.18s, background 0.18s;
                        cursor: pointer;
                        position: relative;
                        height: 64px !important;
                        min-height: 64px !important;
                    }
                    #booking-calendar td.modern-available:hover {
                        box-shadow: 0 8px 32px 0 rgba(51, 132, 255, 0.16), 0 2px 8px 0 rgba(51, 132, 255, 0.10);
                        background: #d6eaff;
                    }
                    #booking-calendar td.modern-unavailable {
                        background: #f6f7fa;
                        color: #b0b0b0;
                        border-radius: 11px;
                        opacity: 0.55;
                        cursor: not-allowed;
                        position: relative;
                        height: 64px !important;
                        min-height: 64px !important;
                    }
                    #booking-calendar tr td:first-child {
                        background: none !important;
                        color: #888;
                        font-size: 0.98em;
                        border-radius: 0;
                        opacity: 1;
                    }
                    #calendar-scroll-wrap {
                        scrollbar-width: thin;
                        scrollbar-color: #bcd6f6 #f3f4f6;
                    }
                    #calendar-scroll-wrap::-webkit-scrollbar {
                        width: 8px;
                        background: #f3f4f6;
                    }
                    #calendar-scroll-wrap::-webkit-scrollbar-thumb {
                        background: #bcd6f6;
                        border-radius: 8px;
                    }
                `;

                addSpaLinkHandlers();
                return;
            }

            // Admin dashboard
            root.innerHTML = `
                <div class="container">
                    ${renderSidebar()}
                    <main class="main">
                        <header class="topbar">
                            <h1>Dashboard</h1>
                            <div class="user-box" id="user-box">
                                <button id="auth-btn">Sign Out</button>
                            </div>
                        </header>
                        <section class="content">
                            <!-- Company Summary -->
                            <div id="dashboard-earnings" class="cards" style="margin-bottom:32px;"></div>
                            <div style="margin-bottom:24px;">
                                <label for="company-filter" style="font-weight:600;">Show companies by:</label>
                                <select id="company-filter" style="margin-left:12px; padding:6px 12px; border-radius:6px;">
                                    <option value="top">Top Performing</option>
                                    <option value="latest">Latest Added</option>
                                </select>
                            </div>
                            <div id="dashboard-companies" class="cards"></div>

                            <!-- Bookings Calendar -->
                            <div id="booking-calendar-section" style="margin-bottom:32px;"></div>

                            <!-- Services -->
                            <div id="services-section" style="margin-bottom:32px;"></div>

                            <!-- Clients -->
                            <div id="clients-section"></div>
                        </section>
                    </main>
                </div>
            `;
            document.getElementById('auth-btn').onclick = () => signOut(auth);

            // Earnings section (placeholder logic)
            let totalSales = 0;
            let totalCompanies = 0;
            // Placeholder: sales collection not yet implemented
            // If you have a sales collection, sum all sales.amount
            // Example: const salesSnap = await getDocs(collection(db, 'sales'));
            // salesSnap.forEach(sale => { totalSales += sale.data().amount; });

            // Companies data
            const companiesSnap = await getDocs(collection(db, "companies"));
            let companies = [];
            companiesSnap.forEach(docSnap => {
                const data = docSnap.data();
                companies.push({
                    id: docSnap.id,
                    name: data.name || 'Unnamed Company',
                    ownerName: data.ownerName || 'Unknown',
                    createdAt: data.createdAt || '',
                    // Placeholder for sales, replace with actual sales data if available
                    sales: data.sales || Math.floor(Math.random() * 10000)
                });
            });
            totalCompanies = companies.length;

            // Earnings tile
            document.getElementById('dashboard-earnings').innerHTML = `
                <div class="card" style="min-width:220px;">
                    <div style="font-size:2em; font-weight:600;">$${totalSales.toLocaleString()}</div>
                    <div style="color:#888;">Total Earnings</div>
                </div>
                <div class="card" style="min-width:220px;">
                    <div style="font-size:2em; font-weight:600;">${totalCompanies}</div>
                    <div style="color:#888;">Total Companies</div>
                </div>
            `;

            // Filter logic
            function renderCompanySubset(filter) {
                let subset = [];
                if (filter === 'top') {
                    subset = companies
                        .sort((a, b) => b.sales - a.sales)
                        .slice(0, 4); // Top 4 companies by sales
                } else {
                    subset = companies
                        .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                        .slice(0, 4); // Latest 4 companies
                }
                document.getElementById('dashboard-companies').innerHTML = subset.map(c => `
                    <div class="card">
                        <h3>${c.name}</h3>
                        <div class="cardOwner">
                            <p>Owner</p>
                            <p>${c.ownerName}</p>
                        </div>
                        <div style="margin-bottom:8px; color:#1976d2; font-weight:500;">Sales: $${c.sales.toLocaleString()}</div>
                        <button class="view-company-btn" data-id="${c.id}">View</button>
                    </div>
                `).join('');
            }

            // Initial render
            renderCompanySubset('top');

            // Filter change handler
            document.getElementById('company-filter').onchange = (e) => {
                renderCompanySubset(e.target.value);
            };

            addSpaLinkHandlers();
        }

        async function renderCompanies() {
            // Render the page structure first
            root.innerHTML = `
    <div class="container">
        ${renderSidebar()}
        <main class="main">
            <header class="topbar">
                <h1>Company Manager</h1>
                <div class="user-box" id="user-box">
                    <button id="auth-btn">Sign Out</button>
                </div>
            </header>
            <section class="content" id="companies-content">
                ${currentRole === 'admin'
                    ? `<button id="add-company-btn" style="margin-bottom:22px;padding:10px 22px;border-radius:7px;background:#4f46e5;color:#fff;font-weight:600;border:none;cursor:pointer;">+ Add Company</button>`
                    : ''
                }
                <div id="company-list"></div>
            </section>
        </main>
    </div>
    ${currentRole === 'admin'
                    ? `<div id="add-company-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:1002;align-items:center;justify-content:center;">
            <div style="background:#fff;padding:32px 28px;border-radius:14px;box-shadow:0 4px 24px rgba(0,0,0,0.09);max-width:370px;width:100%;margin:auto;">
                <h2 style="margin-bottom:18px;font-size:1.2em;font-weight:700;text-align:center;">Add Company & Owner</h2>
                <form id="add-company-form" style="display:flex;flex-direction:column;gap:14px;">
                    <input type="text" id="ac-business" placeholder="Business Name" required style="padding:11px 13px;border-radius:7px;border:1px solid #e5e7eb;">
                    <input type="text" id="ac-name" placeholder="Owner Name" required style="padding:11px 13px;border-radius:7px;border:1px solid #e5e7eb;">
                    <input type="email" id="ac-email" placeholder="Owner Email" required style="padding:11px 13px;border-radius:7px;border:1px solid #e5e7eb;">
                    <input type="tel" id="ac-phone" placeholder="Owner Phone" required style="padding:11px 13px;border-radius:7px;border:1px solid #e5e7eb;">
                    <input type="password" id="ac-password" placeholder="Owner Password" required style="padding:11px 13px;border-radius:7px;border:1px solid #e5e7eb;">
                    <input type="password" id="ac-confirm" placeholder="Confirm Password" required style="padding:11px 13px;border-radius:7px;border:1px solid #e5e7eb;">
                    <div id="ac-error" style="color:#c62828;display:none;font-size:0.98em;"></div>
                    <button type="submit" style="padding:12px 0;border-radius:7px;background:#4f46e5;color:#fff;font-size:1.08em;font-weight:600;border:none;cursor:pointer;">Create</button>
                </form>
                <button id="ac-modal-close" style="display:block;margin:0 auto;margin-top:10px;background:none;border:none;color:#888;font-size:1.1em;cursor:pointer;">Cancel</button>
            </div>
        </div>`
                    : ''
                }
    `;

            document.getElementById('auth-btn').onclick = () => signOut(auth);

            // Add Company modal logic (admin only)
            if (currentRole === 'admin') {
                const modal = document.getElementById('add-company-modal');
                document.getElementById('add-company-btn').onclick = () => {
                    modal.style.display = 'flex';
                };
                document.getElementById('ac-modal-close').onclick = () => {
                    modal.style.display = 'none';
                    document.getElementById('ac-error').style.display = 'none';
                };
                document.getElementById('add-company-form').onsubmit = async (e) => {
                    e.preventDefault();
                    const business = document.getElementById('ac-business').value.trim();
                    const name = document.getElementById('ac-name').value.trim();
                    const email = document.getElementById('ac-email').value.trim();
                    const phoneRaw = document.getElementById('ac-phone').value.trim();
                    const phone = phoneRaw.replace(/\s+/g, ''); // strip whitespace
                    const password = document.getElementById('ac-password').value;
                    const confirm = document.getElementById('ac-confirm').value;
                    const errorBox = document.getElementById('ac-error');
                    errorBox.style.display = 'none';
                    if (password !== confirm) {
                        errorBox.textContent = "Passwords do not match.";
                        errorBox.style.display = 'block';
                        return;
                    }
                    try {
                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        const user = userCredential.user;
                        const userData = {
                            name,
                            email,
                            phone,
                            role: 'owner',
                            business,
                            companyId: user.uid,
                            status: 'active',
                            createdAt: new Date().toISOString()
                        };
                        await setDoc(doc(db, 'users', user.uid), userData);
                        await setDoc(doc(db, 'companies', user.uid), {
                            name: business,
                            ownerUid: user.uid,
                            ownerEmail: email,
                            ownerName: name,
                            ownerPhone: phone,
                            services: [],
                            settings: {
                                timezone: 'America/New_York',
                                bookingWindow: 30,
                                cancellationPolicy: '24 hours notice required',
                                notifications: {
                                    emailEnabled: true,
                                    smsEnabled: false
                                }
                            },
                            totalRevenue: 0,
                            createdAt: new Date().toISOString()
                        });
                        modal.style.display = 'none';
                        route('/companies');
                    } catch (err) {
                        errorBox.textContent = err.message.replace('Firebase: ', '');
                        errorBox.style.display = 'block';
                    }
                };
            }

            // Render company cards after DOM is ready
            let html = '<div class="cards" style="gap:28px;">';
            if (currentRole === 'owner') {
                const companiesRef = collection(db, "companies");
                const q = query(companiesRef, where('ownerUid', '==', currentUser.uid));
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    html += `
                <div class="card" style="margin-bottom:0;">
                    <h3>${data.name || 'Unnamed Company'}</h3>
                    <div class="cardOwner">
                        <p>Owner</p>
                        <p>${data.ownerName || 'Unknown'}</p>
                    </div>
                    <button class="view-company-btn" data-id="${docSnap.id}">View</button>
                </div>
            `;
                });
                html += '</div>';
                document.getElementById('company-list').innerHTML = querySnapshot.size ? html : '<p>No company found for your account.</p>';
            } else if (currentRole === 'admin') {
                const companiesRef = collection(db, "companies");
                const querySnapshot = await getDocs(companiesRef);
                querySnapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    html += `
                <div class="card" style="margin-bottom:0;">
                    <h3>${data.name || 'Unnamed Company'}</h3>
                    <div class="cardOwner">
                        <p>Owner</p>
                        <p>${data.ownerName || 'Unknown'}</p>
                    </div>
                    <button class="view-company-btn" data-id="${docSnap.id}">View</button>
                </div>
            `;
                });
                html += '</div>';
                document.getElementById('company-list').innerHTML = querySnapshot.size ? html : '<p>No companies found.</p>';
            }
            addSpaLinkHandlers();
        }

        async function renderUsers() {
            root.innerHTML = `
        <div class="container">
            ${renderSidebar()}
            <main class="main">
                <header class="topbar">
                    <h1>Business Owners</h1>
                    <div class="user-box" id="user-box">
                        <button id="auth-btn">Sign Out</button>
                    </div>
                </header>
                <section class="content">
                    <div class="card" style="padding:32px 28px;">
                        <h2 style="margin-bottom:18px;">All Business Owners</h2>
                        <div style="margin-bottom:18px;font-weight:600;color:#4f46e5;">Total: <span id="owner-tally"></span></div>
                        <div style="overflow-x:auto;">
                            <table style="width:100%;border-collapse:separate;border-spacing:0 10px;">
                                <thead>
                                    <tr style="background:#f8fafc;">
                                        <th style="text-align:left;padding:12px 10px;color:#4f46e5;font-size:1.05em;">Business Name</th>
                                        <th style="text-align:left;padding:12px 10px;color:#4f46e5;font-size:1.05em;">Owner Name</th>
                                        <th style="text-align:left;padding:12px 10px;color:#4f46e5;font-size:1.05em;">Owner Email</th>
                                        <th style="text-align:left;padding:12px 10px;color:#4f46e5;font-size:1.05em;">Owner Phone</th>
                                    </tr>
                                </thead>
                                <tbody id="owners-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </section>
            </main>
        </div>
    `;
            document.getElementById('auth-btn').onclick = () => signOut(auth);

            // Fetch all business owners from companies collection
            const companiesSnap = await getDocs(collection(db, 'companies'));
            let owners = [];
            companiesSnap.forEach(docSnap => {
                const data = docSnap.data();
                owners.push({
                    business: data.name || '',
                    ownerName: data.ownerName || '',
                    ownerEmail: data.ownerEmail || '',
                    ownerPhone: data.ownerPhone || ''
                });
            });

            // Tally
            document.getElementById('owner-tally').textContent = owners.length;

            // Table rows
            document.getElementById('owners-table-body').innerHTML = owners.map(owner => `
        <tr style="background:#f8fafc;">
            <td style="padding:12px 10px;border-radius:6px 0 0 6px;">${owner.business}</td>
            <td style="padding:12px 10px;">${owner.ownerName}</td>
            <td style="padding:12px 10px;">${owner.ownerEmail}</td>
            <td style="padding:12px 10px;border-radius:0 6px 6px 0;">${formatPhone(owner.ownerPhone)}</td>
        </tr>
    `).join('');

            addSpaLinkHandlers();
        }

        async function renderSettings() {
            // Fetch user doc for name
            let userName = currentUser.displayName || currentUser.email;
            try {
                const userDoc = await getDoc(doc(db, "users", currentUser.uid));
                if (userDoc.exists()) {
                    userName = userDoc.data().name || userName;
                }
            } catch { }
            root.innerHTML = `
        <div class="container">
            ${renderSidebar()}
            <main class="main">
                <header class="topbar">
                    <h1>Settings</h1>
                    <div class="user-box" id="user-box">
                        <button id="auth-btn">Sign Out</button>
                    </div>
                </header>
                <section class="content">
                    <div class="card" style="padding:32px 28px;max-width:100%;margin:40px 0;">
                        <h2 style="margin-bottom:24px;font-size:1.3em;font-weight:700;color:#222;">Your Account</h2>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:32px;">
                            <div style="font-size:1.08em;">
                                <span style="font-weight:600;color:#4f46e5;">Name:</span>
                                <span id="user-info-name" style="margin-left:8px;color:#222;">${userName}</span>
                            </div>
                            <div style="font-size:1.08em;">
                                <span style="font-weight:600;color:#4f46e5;">Email:</span>
                                <span id="user-info-email" style="margin-left:8px;color:#222;">${currentUser.email}</span>
                            </div>
                        </div>
                        <button id="reset-password-btn" style="margin-top:28px;padding:12px 0;border-radius:7px;background:#f8fafc;color:#4f46e5;font-size:1.08em;font-weight:600;border:1px solid #e5e7eb;cursor:pointer;width:100%;">Reset Password</button>
                        <div id="reset-password-msg" style="display:none;margin-top:18px;font-size:1em;"></div>
                    </div>

                    <!-- Weekly Availability Card (Business Owner Only) -->
                    ${(currentRole === 'owner') ? `<div class="card" style="padding:32px 28px;max-width:100%;margin:40px 0;">
                        <h2 style="margin-bottom:18px;font-size:1.2em;font-weight:700;color:#222;">Weekly Availability</h2>
                        <form id="availability-form" style="background:#fff;padding:0;border-radius:12px;">
                            <table style="width:100%;border-collapse:separate;border-spacing:0 8px;">
                                <thead>
                                    <tr>
                                        <th style="text-align:left;padding:8px 4px;">Day</th>
                                        <th style="text-align:center;padding:8px 4px;">Available</th>
                                        <th style="text-align:center;padding:8px 4px;">Start</th>
                                        <th style="text-align:center;padding:8px 4px;">End</th>
                                    </tr>
                                </thead>
                                <tbody id="availability-table-body"></tbody>
                            </table>
                            <div id="availability-error" style="color:#c62828;display:none;font-size:0.98em;margin-top:10px;"></div>
                            <button type="submit" style="margin-top:18px;padding:10px 28px;border-radius:7px;background:#4f46e5;color:#fff;font-weight:600;border:none;cursor:pointer;">Save Availability</button>
                        </form>
                    </div>` : ''}
                </section>
            </main>
        </div>
    `;
            document.getElementById('auth-btn').onclick = () => signOut(auth);
            document.getElementById('reset-password-btn').onclick = async () => {
                const msg = document.getElementById('reset-password-msg');
                msg.style.display = "none";
                msg.style.color = "#1976d2";
                try {
                    await sendPasswordResetEmail(auth, currentUser.email);
                    msg.textContent = "Password reset email sent! Please check your inbox and spam/junk folder.";
                    msg.style.display = "block";
                } catch (err) {
                    msg.textContent = `Error: ${err.code || ''} ${err.message || ''}`;
                    msg.style.display = "block";
                    msg.style.color = "red";
                }
            };

            // --- Availability Logic (Business Owner Only) ---
            if (currentRole === 'owner') {
                // Fetch company info
                let companyDoc = null;
                let companyId = null;
                const companiesRef = collection(db, "companies");
                const q = query(companiesRef, where('ownerUid', '==', currentUser.uid));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    companyDoc = querySnapshot.docs[0].data();
                    companyId = querySnapshot.docs[0].id;
                }
                // Default availability
                const defaultAvailability = [
                    { day: 'Sunday', enabled: false, start: '09:00', end: '17:00' },
                    { day: 'Monday', enabled: true, start: '09:00', end: '17:00' },
                    { day: 'Tuesday', enabled: true, start: '09:00', end: '17:00' },
                    { day: 'Wednesday', enabled: true, start: '09:00', end: '17:00' },
                    { day: 'Thursday', enabled: true, start: '09:00', end: '17:00' },
                    { day: 'Friday', enabled: true, start: '09:00', end: '17:00' },
                    { day: 'Saturday', enabled: false, start: '09:00', end: '17:00' },
                ];
                let availability = (companyDoc && companyDoc.availability) ? companyDoc.availability : defaultAvailability;
                // Render table rows
                const tbody = document.getElementById('availability-table-body');
                tbody.innerHTML = availability.map((a, i) => `
                    <tr>
                        <td style="padding:8px 4px;font-weight:600;">${a.day.slice(0, 3)}</td>
                        <td style="text-align:center;">
                            <input type="checkbox" id="avail-enabled-${i}" ${a.enabled ? 'checked' : ''} />
                        </td>
                        <td style="text-align:center;">
                            <input type="time" id="avail-start-${i}" value="${a.start}" ${a.enabled ? '' : 'disabled'} style="padding:4px 8px;border-radius:6px;border:1px solid #e5e7eb;" />
                        </td>
                        <td style="text-align:center;">
                            <input type="time" id="avail-end-${i}" value="${a.end}" ${a.enabled ? '' : 'disabled'} style="padding:4px 8px;border-radius:6px;border:1px solid #e5e7eb;" />
                        </td>
                    </tr>
                `).join('');
                // Enable/disable time inputs based on checkbox
                for (let i = 0; i < 7; i++) {
                    document.getElementById(`avail-enabled-${i}`).onchange = (e) => {
                        document.getElementById(`avail-start-${i}`).disabled = !e.target.checked;
                        document.getElementById(`avail-end-${i}`).disabled = !e.target.checked;
                    };
                }
                // Save handler
                document.getElementById('availability-form').onsubmit = async (e) => {
                    e.preventDefault();
                    let newAvailability = [];
                    for (let i = 0; i < 7; i++) {
                        const enabled = document.getElementById(`avail-enabled-${i}`).checked;
                        const start = document.getElementById(`avail-start-${i}`).value;
                        const end = document.getElementById(`avail-end-${i}`).value;
                        newAvailability.push({ day: defaultAvailability[i].day, enabled, start, end });
                    }
                    // Validate: start < end for enabled days
                    for (let i = 0; i < 7; i++) {
                        if (newAvailability[i].enabled && newAvailability[i].start >= newAvailability[i].end) {
                            const errBox = document.getElementById('availability-error');
                            errBox.textContent = `Start time must be before end time for ${newAvailability[i].day}.`;
                            errBox.style.display = 'block';
                            return;
                        }
                    }
                    try {
                        await updateDoc(doc(db, 'companies', companyId), { availability: newAvailability });
                        document.getElementById('availability-error').style.display = 'none';
                    } catch (err) {
                        const errBox = document.getElementById('availability-error');
                        errBox.textContent = err.message.replace('Firebase: ', '');
                        errBox.style.display = 'block';
                    }
                };
            }
            addSpaLinkHandlers();
        }

        function getCompanyIdFromPath(path) {
            const match = path.match(/^\/company\/([^/]+)$/);
            return match ? match[1] : null;
        }

        function getCompanyIdFromClientsPath(path) {
            // Works for both /clients?company=ID and /clients?company=ID&...
            const match = path.match(/[?&]company=([^&]+)/);
            return match ? match[1] : null;
        }

        async function renderClients(path) {
            // Extract company ID from URL
            const companyId = getCompanyIdFromClientsPath(path);
            if (!companyId) {
                root.innerHTML = `<p style="color:red;">Invalid company ID.</p>`;
                return;
            }

            // Fetch company data
            const companyDoc = await getDoc(doc(db, "companies", companyId));
            if (!companyDoc.exists()) {
                root.innerHTML = `
                    <div class="container">
                        ${renderSidebar()}
                        <main class="main">
                            <section class="content">
                                <h2>Company not found.</h2>
                                <button onclick="route('/dashboard')">Back to Dashboard</button>
                            </section>
                        </main>
                    </div>
                `;
                addSpaLinkHandlers();
                return;
            }
            const data = companyDoc.data();
            let services = Array.isArray(data.services) ? data.services : [];

            root.innerHTML = `
    <div class="container">
        ${renderSidebar()}
        <main class="main">
            <header class="topbar">
                <h1>Client List for ${data.name || 'Unnamed Company'}</h1>
                <div class="user-box" id="user-box">
                    <button id="auth-btn">Sign Out</button>
                </div>
            </header>
            <section class="content">
                <div class="card" style="padding:32px 28px;margin-bottom:32px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
                        <h2 style="margin-bottom:0;">Clients</h2>
                        <button id="add-client-btn" style="padding:10px 22px;border-radius:7px;background:#4f46e5;color:#fff;font-weight:600;border:none;cursor:pointer;">+ Add Client</button>
                    </div>
                    <div style="overflow-x:auto;">
                        <table style="width:100%;border-collapse:separate;border-spacing:0 10px;">
                            <thead>
                                <tr style="background:#f8fafc;">
                                    <th style="text-align:left;padding:12px 10px;color:#4f46e5;font-size:1.05em;">Client Name</th>
                                    <th style="text-align:left;padding:12px 10px;color:#4f46e5;font-size:1.05em;">Email</th>
                                    <th style="text-align:left;padding:12px 10px;color:#4f46e5;font-size:1.05em;">Phone</th>
                                    <th style="text-align:left;padding:12px 10px;color:#4f46e5;font-size:1.05em;">Address</th>
                                    <th style="text-align:left;padding:12px 10px;color:#4f46e5;font-size:1.05em;">Notes</th>
                                </tr>
                            </thead>
                            <tbody id="clients-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>
    <div id="add-client-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:1002;align-items:center;justify-content:center;">
        <div style="background:#fff;padding:32px 28px;border-radius:14px;box-shadow:0 4px 24px rgba(0,0,0,0.09);max-width:420px;width:100%;margin:auto;">
            <h2 style="margin-bottom:18px;font-size:1.2em;font-weight:700;text-align:center;">Add Client</h2>
            <form id="add-client-form" style="display:flex;flex-direction:column;gap:14px;">
                <input type="text" id="client-name" placeholder="Client Name" required style="padding:11px 13px;border-radius:7px;border:1px solid #e5e7eb;">
                <input type="email" id="client-email" placeholder="Email" required style="padding:11px 13px;border-radius:7px;border:1px solid #e5e7eb;">
                <input type="tel" id="client-phone" placeholder="Phone Number" required style="padding:11px 13px;border-radius:7px;border:1px solid #e5e7eb;">
                <input type="text" id="client-address" placeholder="Address" style="padding:11px 13px;border-radius:7px;border:1px solid #e5e7eb;">
                <textarea id="client-notes" placeholder="Notes" style="padding:11px 13px;border-radius:7px;border:1px solid #e5e7eb;min-height:60px;"></textarea>
                <div id="add-client-error" style="color:#c62828;display:none;font-size:0.98em;"></div>
                <button type="submit" style="padding:12px 0;border-radius:7px;background:#4f46e5;color:#fff;font-size:1.08em;font-weight:600;border:none;cursor:pointer;">Add Client</button>
            </form>
            <button id="add-client-modal-close" style="display:block;margin:0 auto;margin-top:10px;background:none;border:none;color:#888;font-size:1.1em;cursor:pointer;">Cancel</button>
        </div>
    </div>
    `;

            document.getElementById('auth-btn').onclick = () => signOut(auth);

            // Fetch clients for this company (from subcollection)
            let clients = [];
            if (companyId) {
                const clientsSnap = await getDocs(collection(db, "companies", companyId, "clients"));
                clientsSnap.forEach(docSnap => {
                    clients.push({ id: docSnap.id, ...docSnap.data() });
                });
            }

            // Table rows
            document.getElementById('clients-table-body').innerHTML = clients.map(client => `
        <tr style="background:#f8fafc;">
            <td style="padding:12px 10px;border-radius:6px 0 0 6px;">${client.name}</td>
            <td style="padding:12px 10px;">${client.email}</td>
            <td style="padding:12px 10px;">${formatPhone(client.phone)}</td>
            <td style="padding:12px 10px;">${client.address || ''}</td>
            <td style="padding:12px 10px;border-radius:0 6px 6px 0;">${client.notes || ''}</td>
        </tr>
    `).join('');

            // Modal logic
            const modal = document.getElementById('add-client-modal');
            document.getElementById('add-client-btn').onclick = () => {
                modal.style.display = 'flex';
            };
            document.getElementById('add-client-modal-close').onclick = () => {
                modal.style.display = 'none';
                document.getElementById('add-client-error').style.display = 'none';
            };

            document.getElementById('add-client-form').onsubmit = async (e) => {
                e.preventDefault();

                if (!hasPermission('manage_clients', companyId)) {
                    alert('You do not have permission to add clients.');
                    return;
                }

                const name = document.getElementById('client-name').value.trim();
                const email = document.getElementById('client-email').value.trim();
                const phoneRaw = document.getElementById('client-phone').value.trim();
                const phone = phoneRaw.replace(/\s+/g, '');
                const addressStr = document.getElementById('client-address').value.trim();
                const notes = document.getElementById('client-notes').value.trim();
                const errorBox = document.getElementById('add-client-error');
                errorBox.style.display = 'none';

                if (!name || !email || !phone) {
                    errorBox.textContent = "Name, email, and phone are required.";
                    errorBox.style.display = 'block';
                    return;
                }

                try {
                    // Parse address if provided
                    let address = { street: '', city: '', state: '', zipCode: '' };
                    if (addressStr) {
                        address.street = addressStr; // Simple implementation
                    }

                    // Store client in company's subcollection
                    const clientRef = await addDoc(collection(db, 'companies', companyId, 'clients'), {
                        name,
                        email,
                        phone,
                        address,
                        notes,
                        status: 'active',
                        totalBookings: 0,
                        lastBooking: null,
                        createdAt: new Date().toISOString()
                    });
                    modal.style.display = 'none';
                    renderClients(`/clients?company=${companyId}`);
                } catch (err) {
                    errorBox.textContent = err.message.replace('Firebase: ', '');
                    errorBox.style.display = 'block';
                }
            };

            addSpaLinkHandlers();
        }

        async function renderCompanyDetail(companyId) {
            // Fetch company data
            const companyDoc = await getDoc(doc(db, "companies", companyId));
            if (!companyDoc.exists()) {
                root.innerHTML = `
                    <div class="container">
                        ${renderSidebar()}
                        <main class="main">
                            <section class="content">
                                <h2>Company not found.</h2>
                                <button onclick="route('/dashboard')">Back to Dashboard</button>
                            </section>
                        </main>
                    </div>
                `;
                addSpaLinkHandlers();
                return;
            }
            const data = companyDoc.data();
            let services = Array.isArray(data.services) ? data.services : [];
            root.innerHTML = `
<div class="container">
    ${renderSidebar()}
    <main class="main">
        <header class="topbar">
            <h1>Company Details</h1>
            <div class="user-box" id="user-box">
                <button id="auth-btn">Sign Out</button>
            </div>
        </header>
        <section class="content">
            <div class="card" style="padding:32px 28px;margin-bottom:32px;">
                <h2 style="margin-bottom:24px;">${data.name || 'Unnamed Company'}</h2>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:18px;margin-bottom:28px;">
                    <div style="background:#f8fafc;padding:18px 16px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.04);">
                        <span style="font-weight:600;color:#4f46e5;">Owner</span><br>
                        <span>${data.ownerName || 'Unknown'}</span>
                    </div>
                    <div style="background:#f8fafc;padding:18px 16px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.04);">
                        <span style="font-weight:600;color:#4f46e5;">Phone</span><br>
                        <span>${formatPhone(data.ownerPhone) || 'N/A'}</span>
                    </div>
                    <div style="background:#f8fafc;padding:18px 16px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.04);">
                        <span style="font-weight:600;color:#4f46e5;">Email</span><br>
                        <span>${data.ownerEmail || 'N/A'}</span>
                    </div>
                </div>
                <button class="btn" id="see-clients-btn" style="margin-bottom:18px;">See Client List</button>
                <div class="section-space"></div>
                <h3 style="margin-bottom:16px;">Services & Prices</h3>
                <div style="margin-bottom:0;">
                    <form id="services-form">
                    <table style="width:100%;margin-top:8px;border-collapse:separate;border-spacing:0 10px;">
                        <thead>
                            <tr>
                                <th style="text-align:left;padding:10px 8px;color:#4f46e5;font-size:1.08em;">Service</th>
                                <th style="text-align:left;padding:10px 8px;color:#4f46e5;font-size:1.08em;">Price</th>
                                ${(currentRole === 'admin' || currentRole === 'owner') ? `<th></th>` : ''}
                            </tr>
                        </thead>
                        <tbody id="services-table-body">
                            ${services.length === 0 ? '<tr><td colspan="3" style="color:#888;">No services listed.</td></tr>' : services.map((s, idx) => `
                                <tr style="background:#f8fafc;">
                                    <td style="padding:10px 8px;border-radius:6px 0 0 6px;">${s.name}</td>
                                    <td style="padding:10px 8px;border-radius:0 6px 6px 0;">$${s.price}</td>
                                    ${(currentRole === 'admin' || currentRole === 'owner') ? `<td style="text-align:center;">
        <button type="button" class="remove-service-btn" data-idx="${idx}"
            style="
                background:#fff;
                border:none;
                border-radius:12px;
                width:32px;
                height:32px;
                box-shadow:0 1px  4px rgba(0,0,0,0.07);
                display:flex;
                align-items:center;
                justify-content:center;
                cursor:pointer;
                transition:background 0.18s;
                padding:0;
            "
            onmouseover="this.style.background='#ffeaea'"
            onmouseout="this.style.background='#fff'"
            aria-label="Remove service"
        >
            <svg width="18" height="18" viewBox="0 0 18 18" fill="none" style="display:block;" xmlns="http://www.w3.org/2000/svg">
                <rect x="4.2" y="3.8" width="9.6" height="9.6" rx="4.8" fill="#fff"/>
                <path d="M6 6L12 12M12 6L6 12" stroke="#e53935" stroke-width="2.2" stroke-linecap="round"/>
            </svg>
        </button>
    </td>` : ''}
                                </tr>
                            `).join('')}
                            ${(currentRole === 'admin' || currentRole === 'owner') ? `
                                <tr style="background:#f8fafc;">
                                    <td style="padding:10px 8px;">
                                        <input type="text" id="new-service-name" placeholder="Service name" style="width:90%;padding:8px 12px;border-radius:10px;border:1px solid #e5e7eb;font-size:1em;">
                                    </td>
                                    <td style="padding:10px 8px;">
                                        <input type="number" id="new-service-price" placeholder="Price" style="width:70%;padding:8px 12px;border-radius:10px;border:1px solid #e5e7eb;font-size:1em;">
                                    </td>
                                    <td style="text-align:center;">
                                        <button type="button" id="add-service-btn"
                                            style="
                                                background:#fff;
                                                border:none;
                                                border-radius:12px;
                                                width:32px;
                                                height:32px;
                                                box-shadow:0 1px 4px rgba(0,0,0,0.07);
                                                display:flex;
                                                align-items:center;
                                                justify-content:center;
                                                cursor:pointer;
                                                transition:background 0.18s;
                                                padding:0;
                                            "
                                            onmouseover="this.style.background='#e6faed'"
                                            onmouseout="this.style.background='#fff'"
                                            aria-label="Add service"
                                        >
                                            <svg width="18" height="18" viewBox="0 0 18 18" fill="none" style="display:block;" xmlns="http://www.w3.org/2000/svg">
                                                <rect x="4.2" y="3.8" width="9.6" height="9.6" rx="4.8" fill="#fff"/>
                                                <path d="M9 6V12M6 9H12" stroke="#22c55e" stroke-width="2.2" stroke-linecap="round"/>
                                            </svg>
                                        </button>
                                    </td>
                                </tr>
                            ` : ''}
                        </tbody>
                    </table>
                    <div id="services-error" style="color:#c62828;display:none;font-size:0.98em;margin-top:8px;"></div>
                    </form>
                </div>
            </div>
        </section>
    </main>
</div>
`;
            document.getElementById('auth-btn').onclick = () => signOut(auth);
            document.getElementById('see-clients-btn').onclick = (e) => {
                e.preventDefault();
                window.history.pushState({}, '', `/clients?company=${companyId}`);
                renderClients(`/clients?company=${companyId}`);
            };
            addSpaLinkHandlers();

            // Service editing logic for admin and owner
            if (currentRole === 'admin' || currentRole === 'owner') {
                // Remove service
                document.querySelectorAll('.remove-service-btn').forEach(btn => {
                    btn.onclick = async () => {
                        const idx = parseInt(btn.getAttribute('data-idx'));
                        const updated = services.slice();
                        updated.splice(idx, 1);
                        try {
                            await updateDoc(doc(db, "companies", companyId), { services: updated });
                            renderCompanyDetail(companyId);
                        } catch (err) {
                            const errBox = document.getElementById('services-error');
                            errBox.textContent = err.message.replace('Firebase: ', '');
                            errBox.style.display = 'block';
                        }
                    };
                });
                // Add service
                document.getElementById('add-service-btn').onclick = async () => {
                    if (!hasPermission('manage_company', companyId)) {
                        alert('You do not have permission to add services.');
                        return;
                    }

                    const name = document.getElementById('new-service-name').value.trim();
                    const price = document.getElementById('new-service-price').value.trim();
                    const errBox = document.getElementById('services-error');
                    errBox.style.display = 'none';
                    if (!name || !price || isNaN(price)) {
                        errBox.textContent = "Please enter a valid service name and price.";
                        errBox.style.display = 'block';
                        return;
                    }

                    const newService = {
                        id: generateId(),
                        name,
                        price: Number(price),
                        duration: 60, // Default 1 hour
                        description: '',
                        active: true
                    };
                    const updated = services.concat([newService]);
                    try {
                        await updateDoc(doc(db, "companies", companyId), { services: updated });
                        renderCompanyDetail(companyId);
                    } catch (err) {
                        errBox.textContent = err.message.replace('Firebase: ', '');
                        errBox.style.display = 'block';
                    }
                };
            }
        }

        // Main view renderer
        async function renderView(path) {
            // Add company detail route FIRST so it matches before role-based navigation
            const companyId = getCompanyIdFromPath(path);
            if (companyId) return renderCompanyDetail(companyId);

            // Add company-specific clients route BEFORE role-based navigation
            if (getCompanyIdFromClientsPath(window.location.pathname + window.location.search)) {
                return renderClients(window.pathname + window.location.search);
            }

            if (!currentUser) {
                // Always render login view, but do NOT call route('/login') if already on /login
                if (path !== '/login' && path !== '/signup' && path !== '/reset') {
                    renderLogin();
                    return;
                }
                if (path === '/login') return renderLogin();
                if (path === '/signup') return renderSignup();
                if (path === '/reset') return renderReset();
                return renderLogin();
            }
            // Role-based navigation
            if (currentRole === 'owner') {
                if (path === '/dashboard' || path === '/') return renderDashboard();
                if (path === '/settings') return renderSettings();
                if (path === '/clients') return renderClients();
                if (path === '/companies') return renderCompanies();
                return renderDashboard();
            } else if (currentRole === 'admin') {
                if (path === '/dashboard' || path === '/') return renderDashboard();
                if (path === '/settings') return renderSettings();
                if (path === '/companies') return renderCompanies();
                if (path === '/users') return renderUsers();
                if (path === '/landing') return renderLanding();
                return renderDashboard();
            }
            // Default fallback
            return renderLanding();
        }

        // SPA link handler
        function addSpaLinkHandlers() {
            document.querySelectorAll('.spa-link').forEach(link => {
                link.onclick = (e) => {
                    e.preventDefault();
                    const href = link.getAttribute('href');
                    // Owner: "Clients" tab should route to their company client list
                    if (currentRole === 'owner' && href === '/clients') {
                        // Find owner's company ID
                        (async () => {
                            const companiesRef = collection(db, "companies");
                            const q = query(companiesRef, where('ownerUid', '==', currentUser.uid));
                            const querySnapshot = await getDocs(q);
                            if (!querySnapshot.empty) {
                                const companyId = querySnapshot.docs[0].id;
                                route(`/clients?company=${companyId}`);
                            } else {
                                route('/clients'); // fallback, will show error
                            }
                        })();
                    } else {
                        route(href);
                    }
                };
            });
            // Add handler for company card "View" buttons
            document.querySelectorAll('.view-company-btn').forEach(btn => {
                btn.onclick = (e) => {
                    const id = btn.getAttribute('data-id');
                    if (id) route(`/company/${id}`);
                };
            });
        }

        // Auth and initial route
        onAuthStateChanged(auth, async user => {
            if (user) {
                currentUser = user;
                let role = null;
                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists()) role = userDoc.data().role;
                } catch { }
                currentRole = role;
                // Only allow admin/owner
                if (role !== "admin" && role !== "owner") {
                    currentUser = null;
                    currentRole = null;
                    route('/login');
                    return;
                }
                renderView(window.location.pathname);
            } else {
                currentUser = null;
                currentRole = null;
                // Redirect to login page when user signs out
                route('/login');
            }
        });

        // Initial load
        renderView(window.location.pathname);

    </script>
</body>

</html>